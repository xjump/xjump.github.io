

<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>@xjump</title>

      
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https:&#x2F;&#x2F;xjump.me&#x2F;rss.xml">
      

      
          <script src="/slideout/1.0.1/slideout.min.js"></script>
          
          <link rel="stylesheet" href="/katex/0.10.1/katex.min.css">

          <script defer src="/katex/0.10.1/katex.min.js" ></script>
          <script defer src="/katex/0.10.1/contrib/mathtex-script-type.min.js" ></script>
              
          <script defer src="/katex/0.10.1/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
              
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;xjump.me&#x2F;site.css">
          
          <link rel="stylesheet" href="/katex/0.10.1/katex.min.css"  >
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">@xjump</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me&#x2F;tags&#x2F;all">
                            Archive
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me&#x2F;rss.xml">
                            RSS
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://xjump.me&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;xjump.me">@xjump</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https://xjump.me">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://xjump.me&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://xjump.me&#x2F;tags&#x2F;all">
                                    Archive
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://xjump.me&#x2F;rss.xml">
                                    RSS
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://xjump.me&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://xjump.me/20190701-flink-intro/#1-flinkyu-da-shu-ju-ji-suan" class="toc-link">1 flink与大数据计算</a>
                    
                </li>
                
                <li>
                    <a href="https://xjump.me/20190701-flink-intro/#2-dan-ji-ji-suan-ying-yong" class="toc-link">2 单机计算应用</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://xjump.me/20190701-flink-intro/#2-1-xia-zai-bing-qi-dong-flink" class="toc-link">2.1 下载并启动flink</a>
                        </li>
                        
                        <li>
                            <a href="https://xjump.me/20190701-flink-intro/#2-2-bian-xie-jian-dan-de-ji-suan-ying-yong" class="toc-link">2.2 编写简单的计算应用</a>
                        </li>
                        
                        <li>
                            <a href="https://xjump.me/20190701-flink-intro/#2-3-ce-shi-diao-shi-ji-suan-ying-yong" class="toc-link">2.3 测试&amp;调试计算应用</a>
                        </li>
                        
                        <li>
                            <a href="https://xjump.me/20190701-flink-intro/#2-4-bian-xie-shi-yong-de-ji-suan-ying-yong" class="toc-link">2.4 编写实用的计算应用</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    <a href="https://xjump.me/20190701-flink-intro/#3-wen-ti-ji-xia-yi-bu" class="toc-link">3 问题及下一步</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://xjump.me/20190701-flink-intro/#3-1-scalayu-flinkde-ban-ben-chong-tu-wen-ti" class="toc-link">3.1 scala与flink的版本冲突问题</a>
                        </li>
                        
                        <li>
                            <a href="https://xjump.me/20190701-flink-intro/#3-2-flinkhe-xin-gai-nian-jie-shao" class="toc-link">3.2 flink核心概念介绍</a>
                        </li>
                        
                        <li>
                            <a href="https://xjump.me/20190701-flink-intro/#3-3-dan-ji-mo-shi-xia-ce-shi-wen-ti" class="toc-link">3.3 单机模式下测试问题</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;xjump.me&#x2F;20190701-flink-intro&#x2F;">flink应用(1)</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2019-07-01</span>
            
        </div>
    </header>

    <div class="post-content">
      <h2 id="1-flinkyu-da-shu-ju-ji-suan">1 flink与大数据计算</h2>
<p>flink以Stream模型为基础对数据计算进行建模，为批和流的处理实现了统一。并在低延迟、稳定性、编程接口友好等方面具有较大的优势，是大数据实时计算的利器。从下图（摘自官方）可以看出，flink将来自各个数据源（Source）的数据进行计算，让后将结果交给各个下游数据宿（Sink）进行后续消费。同时，对于Source和Sink也可以是flink计算应用，进行更复杂的级联，构建更丰富的数据处理模式。</p>
<p><center>
<img alt="flink" src="/images/flink/flink-home-graphic.png" style="width: 800px; height: 263px;" />
</center></p>
<p><a name="continue-reading"></a></p>
<p>flink有较多的线上应用背书，其优化版本<a href=https://yq.aliyun.com/articles/326161>Blink</a>经历过阿里巴巴生产环境双11考验，实现了每秒4亿次计算、毫秒级延迟的目标。并且，随着Blink SQL逐步集成到开源flink项目中，其通用性和易用性都具有较大的提升，相信越来越多的大数据计算会利用flink来构建。</p>
<p>下面先介绍一个简单的单机计算应用Demo。</p>
<h2 id="2-dan-ji-ji-suan-ying-yong">2 单机计算应用</h2>
<p>这部分将通过创建简单的计算应用到创建真实的PV、UV计算应用，来体验flink。</p>
<h3 id="2-1-xia-zai-bing-qi-dong-flink">2.1 下载并启动flink</h3>
<p>首先下载并启动flink，这一步并非必须，只是为了更好的在单机进行集群模拟体验。</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">wget</span><span style="color:#c0c5ce;"> http://mirror.bit.edu.cn/apache/flink/flink-1.8.1/flink-1.8.1-bin-scala_2.12.tgz</span><span style="color:#c0c5ce;">
</span><span style="color:#bf616a;">tar</span><span style="color:#c0c5ce;"> zxf flink-1.8.1-bin-scala_2.12.tgz</span><span style="color:#c0c5ce;">
</span><span style="color:#96b5b4;">cd</span><span style="color:#c0c5ce;"> flink-1.8.1/bin</span><span style="color:#c0c5ce;">
</span><span style="color:#bf616a;">./start-cluster.sh</span><span style="color:#c0c5ce;">
</span></pre>
<p>Windows下比较简单，下载解压后通过<code>start-cluster.bat</code>进行启动。</p>
<p>通过上述<code>start-cluster</code>启动脚本输出情况，判断是否启动正常，并访问<code>http://127.0.0.1:8081</code>查看flink工作情况。</p>
<h3 id="2-2-bian-xie-jian-dan-de-ji-suan-ying-yong">2.2 编写简单的计算应用</h3>
<p>计算应用可以选择Java或Scala语言来编写。根据使用不同层面的API，可以选择低级别的functor和高级别的SQL来实现计算逻辑。</p>
<p>下面通过Scala编写的简单PV、UV计算来进行说明。</p>
<p>首先，参考<a href=https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/projectsetup/scala_api_quickstart.html>这里</a>使用maven模板创建应用：</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">mvn</span><span style="color:#c0c5ce;"> archetype:generate</span><span style="color:#bf616a;"> -DarchetypeGroupId</span><span style="color:#c0c5ce;">=org.apache.flink</span><span style="color:#bf616a;"> -DarchetypeArtifactId</span><span style="color:#c0c5ce;">=flink-quickstart-scala</span><span style="color:#bf616a;"> -DarchetypeVersion</span><span style="color:#c0c5ce;">=1.8.0</span><span style="color:#c0c5ce;">
</span></pre>
<p>根据archtype生成project通过</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">mvn</span><span style="color:#c0c5ce;"> idea:idea</span><span style="color:#c0c5ce;">
</span></pre>
<p>创建idea项目文件，导入idea。</p>
<p>修改StreamingJob如下：</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">package </span><span style="color:#c0c5ce;">me.xjump</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">import </span><span style="color:#bf616a;">org.apache.flink.streaming.api.scala._</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">import </span><span style="color:#bf616a;">org.apache.flink.streaming.api.windowing.time.Time</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">object </span><span style="color:#ebcb8b;">StreamingJob </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">main</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">args</span><span style="color:#eff1f5;">: </span><span style="color:#ebcb8b;">Array</span><span style="color:#eff1f5;">[</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">]) {</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">val </span><span style="color:#eff1f5;">env </span><span style="color:#c0c5ce;">= </span><span style="color:#eff1f5;">StreamExecutionEnvironment.getExecutionEnvironment</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">val </span><span style="color:#eff1f5;">text </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> env.socketTextStream(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">localhost</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">, </span><span style="color:#d08770;">9999</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">val </span><span style="color:#eff1f5;">words </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> text.flatMap {</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#bf616a;">_</span><span style="color:#eff1f5;">.toLowerCase.split(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#96b5b4;">\\</span><span style="color:#a3be8c;">W+</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">.filter {</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#bf616a;">_</span><span style="color:#eff1f5;">.nonEmpty</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">val </span><span style="color:#eff1f5;">count </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> words</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">.map {</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">_</span><span style="color:#eff1f5;">, </span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">.keyBy(</span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">.timeWindow(Time.seconds(</span><span style="color:#d08770;">5</span><span style="color:#eff1f5;">))</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">.sum(</span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">count.print</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">env.execute(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Flink Streaming Scala demo1</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">  </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">}</span><span style="color:#c0c5ce;">
</span></pre><h3 id="2-3-ce-shi-diao-shi-ji-suan-ying-yong">2.3 测试&调试计算应用</h3>
<p>启动nc监听socket</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">#windows</span><span style="color:#65737e;">
</span><span style="color:#bf616a;">nc -l -p</span><span style="color:#c0c5ce;"> 9999</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">#*nix</span><span style="color:#65737e;">
</span><span style="color:#bf616a;">nc -lk</span><span style="color:#c0c5ce;"> 9999</span><span style="color:#c0c5ce;">
</span></pre>
<p>然后，启动flink计算应用，也就是启动上述StreamingJob的main，可以在idea中直接运行main函数。</p>
<p>注意顺序不要弄反了，否则可能导致StreamingJob启动失败。</p>
<p>在nc命令窗口输入</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">I like apple, you like orange.</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">go go go</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">flink streaming job.</span><span style="color:#c0c5ce;">
</span></pre>
<p>然后在StreamingJob的控制台看到计算结果：</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">2&gt; (i,1)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">10&gt; (like,2)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">7&gt; (you,1)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">10&gt; (apple,1)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">7&gt; (orange,1)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">8&gt; (go,3)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">2&gt; (streaming,1)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">12&gt; (job,1)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">10&gt; (flink,1)</span><span style="color:#c0c5ce;">
</span></pre>
<p>在idea中下断点，可以对StreamingJob进行调试。</p>
<h3 id="2-4-bian-xie-shi-yong-de-ji-suan-ying-yong">2.4 编写实用的计算应用</h3>
<p>现在，让我们来实现带滑动窗口的PV、UV计算应用。</p>
<p>首先，需要对flink中的几个核心的概念进行介绍。</p>
<h4 id="2-4-1-shi-jian">2.4.1 时间</h4>
<p>实时计算的一个核心数据维度是时间。时间是<code>流</code>的固有属性，有了时间，数据才能真正被描述成流动的，基于<code>流</code>的计算，本质上是基于某个时间区间的数据处理，以提取该区间内数据的某种商业特征为目标。flink中的时间分为3种类型：</p>
<ul>
<li>
<p><code>Event Time</code>
指的是时间发生的时间。对于flink应用，EventTime将通过Event的生产者指定，如通过附加在Event数据中的一个字段来指定。由于这个时间是Event的生产者指定的，所以原则上是无法保证正确性的，flink应用100%完全信任这个时间。通常在flink应用中解析提取该字段后进行应用。</p>
</li>
<li>
<p><code>Processing Time</code>
指的是执行计算的flink节点进行某个operation时的时间，从该计算节点的系统时钟来获取。</p>
</li>
<li>
<p><code>Ingest Time</code>
指的是Source操作获取到Event时，进行Source操作的时间，从该Source操作节点的系统时钟来获取。</p>
</li>
</ul>
<h4 id="2-4-2-chuang-kou">2.4.2 窗口</h4>
<p>窗口(Window)又可以理解为时间区间，flink中的窗口有4种：</p>
<ul>
<li><code>Tumbling Window</code>
可以翻译为翻滚窗口。指的是按照一定的区间长度来切分时间，并且区间的起点、终点都是固定的。比如每天从00:00:00到23:59:59，或者每分钟，每小时等等。窗口对应的时间区间起点、终点是固定的，区间长度也是固定的。例如</li>
</ul>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">TumblingProcessingTimeWindows.of(Time.seconds(</span><span style="color:#d08770;">5</span><span style="color:#c0c5ce;">))</span><span style="color:#c0c5ce;">
</span></pre>
<p>表示以ProcessingTime为基准，每5秒一个翻滚窗口来创建window。</p>
<ul>
<li><code>Sliding Window</code>
可以翻译为滑动窗口。指的是按照一定的区间长度来切分时间，但区间的起点、终点都是在移动的。比如最后15分钟，最后一周，最后3小时等等。窗口对应的时间区间只有长度固定，而起点、终点都不固定。例如</li>
</ul>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">SlidingEventTimeWindows.of(Time.seconds(</span><span style="color:#d08770;">30</span><span style="color:#c0c5ce;">), Time.seconds(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">))</span><span style="color:#c0c5ce;">
</span></pre>
<p>表示以EventTime为基准，30秒为滑动窗口长度，最小滑动单位为1秒来创建window。flink可以指定的最小滑动单位的最小值是1毫秒。</p>
<ul>
<li><code>Session Window</code>
可以翻译为会话窗口。指的是按照相邻两个时间的时间间隔为窗口边界，但区间的起点、终点都是不固定的。比如最小间隔为10秒，那么相邻事件超过10秒的将归为不同的窗口。例如</li>
</ul>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">ProcessingTimeSessionWindows.withGap(Time.minutes(</span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">))</span><span style="color:#c0c5ce;">
</span></pre>
<p>表示以ProcessingTime为基准，10分钟为Gap（时间间隔）来创建window。该窗口起点和终点都不固定，长度也不固定，但如果相邻两个事件间隔超过了10分钟，那么后一个事件将属于一个新的窗口。</p>
<p>又例如</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">DynamicProcessingTimeSessionWindows.withDynamicGap(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">SessionWindowTimeGapExtractor</span><span style="color:#c0c5ce;">[</span><span style="color:#ebcb8b;">String</span><span style="color:#c0c5ce;">] {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">  </span><span style="color:#b48ead;">override def </span><span style="color:#8fa1b3;">extract</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">element</span><span style="color:#c0c5ce;">: </span><span style="color:#ebcb8b;">String</span><span style="color:#c0c5ce;">): </span><span style="color:#b48ead;">Long </span><span style="color:#c0c5ce;">= {</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// determine and return session gap</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">  </span><span style="color:#c0c5ce;">}</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">})</span><span style="color:#c0c5ce;">
</span></pre>
<p>表示以ProcessingTime为基准，从一个String为Event对象的事件中动态提取窗口间隔值，来动态的创建会话窗口。</p>
<ul>
<li><code>Global Window</code>
可以翻译为全局窗口。指的是时间区间是无界的。全局窗口通过如下方式创建</li>
</ul>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">GlobalWindows.create()</span><span style="color:#c0c5ce;">
</span></pre><h4 id="2-4-3-ji-suan-pvhe-uv">2.4.3 计算PV和UV</h4>
<p>有了上述时间和窗口的概念，计算PV和UV可以翻译为：在一定的时间内，访问某个URL的次数和用户数。由于一个URL被访问一次可以直接计数，但多个URL被多个用户访问，可能存在用户访问多个URL的情况，所以对于用户的计数是要去重的，也就是需要进行Distinct Count。</p>
<p>这里窗口选择上可以是翻滚窗口，也可以是滑动窗口，看需要而定。</p>
<p>修改StreamingJob如下</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">package </span><span style="color:#c0c5ce;">me.xjump</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">import </span><span style="color:#bf616a;">org.apache.flink.streaming.api.scala._</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">import </span><span style="color:#bf616a;">org.apache.flink.streaming.api.scala.extensions._</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">import </span><span style="color:#bf616a;">org.apache.flink.streaming.api.windowing.assigners.TumblingProcessingTimeWindows</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">import </span><span style="color:#bf616a;">org.apache.flink.streaming.api.windowing.time.Time</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">import </span><span style="color:#bf616a;">org.apache.flink.streaming.api.windowing.triggers.ContinuousProcessingTimeTrigger</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">object </span><span style="color:#ebcb8b;">StreamingJob </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">main</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">args</span><span style="color:#eff1f5;">: </span><span style="color:#ebcb8b;">Array</span><span style="color:#eff1f5;">[</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">]) {</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">val </span><span style="color:#eff1f5;">env </span><span style="color:#c0c5ce;">= </span><span style="color:#eff1f5;">StreamExecutionEnvironment.getExecutionEnvironment</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">val </span><span style="color:#eff1f5;">text </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> env.socketTextStream(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">localhost</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">, </span><span style="color:#d08770;">9999</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">val </span><span style="color:#eff1f5;">dataInput </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> text.map(</span><span style="color:#bf616a;">x</span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#b48ead;">val </span><span style="color:#eff1f5;">it </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> x.split(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">,</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">.filter {</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#bf616a;">_</span><span style="color:#eff1f5;">.nonEmpty</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">it </span><span style="color:#65737e;">// it(0)=url,it(1)=uid</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">})</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">val </span><span style="color:#eff1f5;">pvuv </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> dataInput</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">.keyBy(</span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">.window(TumblingProcessingTimeWindows.of(Time.seconds(</span><span style="color:#d08770;">5</span><span style="color:#eff1f5;">)))</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">.trigger(ContinuousProcessingTimeTrigger.of(Time.seconds(</span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">)))</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">.applyWith((</span><span style="color:#c0c5ce;">&quot;&quot;</span><span style="color:#eff1f5;">, List.empty[</span><span style="color:#b48ead;">Int</span><span style="color:#eff1f5;">], Set.empty[</span><span style="color:#b48ead;">Int</span><span style="color:#eff1f5;">], </span><span style="color:#d08770;">0L</span><span style="color:#eff1f5;">, </span><span style="color:#d08770;">0L</span><span style="color:#eff1f5;">))(</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">foldFunction </span><span style="color:#c0c5ce;">= </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">          </span><span style="color:#b48ead;">case</span><span style="color:#eff1f5;"> ((</span><span style="color:#bf616a;">_</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">list</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">set</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">_</span><span style="color:#eff1f5;">, </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">), </span><span style="color:#bf616a;">item</span><span style="color:#eff1f5;">) </span><span style="color:#c0c5ce;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">val </span><span style="color:#eff1f5;">url:</span><span style="color:#ebcb8b;">String </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> item(</span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">val </span><span style="color:#eff1f5;">uid:</span><span style="color:#ebcb8b;">String </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> item(</span><span style="color:#d08770;">1</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">(url + </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">_</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;"> + uid, url.hashCode +: list, set + uid.hashCode, </span><span style="color:#d08770;">0L</span><span style="color:#eff1f5;">, </span><span style="color:#d08770;">0L</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">          </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">, windowFunction </span><span style="color:#c0c5ce;">= </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">          </span><span style="color:#b48ead;">case</span><span style="color:#eff1f5;"> (</span><span style="color:#bf616a;">key</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">window</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">result</span><span style="color:#eff1f5;">) </span><span style="color:#c0c5ce;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">result.map {</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">              </span><span style="color:#b48ead;">case</span><span style="color:#eff1f5;"> (</span><span style="color:#bf616a;">it</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">list</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">set</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">_</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">_</span><span style="color:#eff1f5;">) </span><span style="color:#c0c5ce;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">(it, list.size, set.size, window.getStart, window.getEnd)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">              </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">          </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">).keyBy(</span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">.flatMapWithState[(</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">Int</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">Int</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">Long</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">Long</span><span style="color:#eff1f5;">),(</span><span style="color:#b48ead;">Int</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">Int</span><span style="color:#eff1f5;">)]{</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">case</span><span style="color:#eff1f5;"> ((</span><span style="color:#bf616a;">key</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">numpv</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">numuv</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">begin</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">end</span><span style="color:#eff1f5;">), </span><span style="color:#bf616a;">curr</span><span style="color:#eff1f5;">) </span><span style="color:#c0c5ce;">=&gt;</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">          </span><span style="color:#eff1f5;">curr </span><span style="color:#b48ead;">match </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">case </span><span style="color:#eff1f5;">Some(</span><span style="color:#bf616a;">numCurr</span><span style="color:#eff1f5;">) </span><span style="color:#b48ead;">if</span><span style="color:#eff1f5;"> numCurr == (numuv, numpv) </span><span style="color:#c0c5ce;">=&gt;</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">              </span><span style="color:#eff1f5;">(Seq.empty, Some((numuv, numpv)))</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">_ </span><span style="color:#c0c5ce;">=&gt;</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">              </span><span style="color:#eff1f5;">(Seq((key, numpv, numuv, begin, end)), Some((numuv, numpv)))</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">          </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">val </span><span style="color:#eff1f5;">resulted </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> pvuv.map(</span><span style="color:#bf616a;">x </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">{</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#b48ead;">val </span><span style="color:#eff1f5;">keys </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> x._1.split(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">_</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#eff1f5;">(keys(</span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">), x._2, x._3)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">})</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">resulted.print</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">env.execute(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Flink Streaming pv &amp; uv</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">)</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">  </span><span style="color:#eff1f5;">}</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">}</span><span style="color:#c0c5ce;">
</span></pre>
<p>同样的，在nc窗口输入：</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">url,uid1212</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">url2,uid1212</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">url3,uid1212</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">url,uid1212</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">url,uid1213</span><span style="color:#c0c5ce;">
</span></pre>
<p>将会在StreamingJob的main控制台看到输出</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">3&gt; (url,1,1)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">5&gt; (url2,1,1)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">7&gt; (url3,1,1)</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">7&gt; (url,1,1)</span><span style="color:#c0c5ce;">
</span></pre>
<p>最后在<code>http://127.0.0.1:8081</code>进行集群（尽管是单节点）进行Job提交，步骤如下
首先生成jar包</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">mvn</span><span style="color:#c0c5ce;"> clean package</span><span style="color:#c0c5ce;">
</span></pre>
<p>然后将jar文件提交通过web console提交，并启动任务。</p>
<p>最后在nc窗口输入数据，观察stdout的输出结果。</p>
<h2 id="3-wen-ti-ji-xia-yi-bu">3 问题及下一步</h2>
<h3 id="3-1-scalayu-flinkde-ban-ben-chong-tu-wen-ti">3.1 scala与flink的版本冲突问题</h3>
<p>测试过程中发现scala 2.12.8与flink 1.8.1-scala_2.12冲突，将StreamingJob切换到scala_2.12.7解决。</p>
<p>问题现象为StreamingJob启动报错</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">java.lang.NoClassDefFoundError: scala/math/Ordering$$anon$9</span><span style="color:#c0c5ce;">
</span></pre>
<p>flink项目bug参考：<a href=http://mail-archives.apache.org/mod_mbox/flink-issues/201905.mbox/%3cJIRA.13232397.1557388276000.223081.1557391740894@Atlassian.JIRA%3e>FLINK-12461</a></p>
<h3 id="3-2-flinkhe-xin-gai-nian-jie-shao">3.2 flink核心概念介绍</h3>
<p>本文介绍了flink的两个核心概念：Time与Window，另外还有Trigger、WindowFunction、Wartermark、Connector、checkpoint、savepoint等等一系列概念将在后续文章进行介绍。</p>
<h3 id="3-3-dan-ji-mo-shi-xia-ce-shi-wen-ti">3.3 单机模式下测试问题</h3>
<p>Web Console提交的job无法删除（window平台，mac、linux无问题）</p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <!-- <a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all&#x2F;">#all</a> -->
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;xjump.me&#x2F;android-dex-dynamic-load-call-and-security&#x2F;">‹ Android Dex动态加载、调用与安全</a>
                    
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;xjump.me&#x2F;even.js" ></script>
      
    </body>

</html>
