<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title>@xjump</title>


  <script type="text/javascript" src="/slideout/1.0.1/slideout.min.js"></script>

  <link rel="stylesheet" href="/katex/0.10.1/katex.min.css">
  <script type="text/javascript" defer src="/katex/0.10.1/katex.min.js" ></script>
  <script type="text/javascript" defer src="/katex/0.10.1/contrib/mathtex-script-type.min.js" ></script>

  <script type="text/javascript" defer src="/katex/0.10.1/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>




  <link rel="stylesheet" href="/site.css">

  <link rel="stylesheet" href="/katex/0.10.1/katex.min.css"  >





</head>

<body>
  <div class="container">
    <div id="mobile-navbar" class="mobile-navbar">
      <div class="mobile-header-logo">
      <a href="/" class="logo">@xjump</a>
      </div>
      <div class="mobile-navbar-icon icon-out">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>

    <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
      <ul class="mobile-menu-list">
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me">Home</a>
        </li>
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;categories">Categories</a>
        </li>
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all">Archive</a>
        </li>
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;rss.xml">RSS</a>
        </li>
      
        <li class="mobile-menu-item">
        <a href="https:&#x2F;&#x2F;xjump.me&#x2F;about">About</a>
        </li>
      
      </ul>
    </nav>

    <header id="header">
      <div class="logo"><a href="https:&#x2F;&#x2F;xjump.me">@xjump</a></div>
      <nav class="menu">
        <ul>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me">Home </a></li>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me&#x2F;categories">Categories </a></li>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me&#x2F;tags&#x2F;all">Archive </a></li>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me&#x2F;rss.xml">RSS </a></li>
        
    <li><a href="https:&#x2F;&#x2F;xjump.me&#x2F;about">About </a></li>
        
        </ul>
      </nav>
    </header>

    <main>
      <div class="content" id="mobile-panel">




<article class="post">

<header class="post__header">
  <h1 class="post__title"><a href="https:&#x2F;&#x2F;xjump.me&#x2F;20140910-object-c-cpp1x-singleton&#x2F;">ObjC &amp; Swift &amp; C++1x Singleton</a></h1>
  <div class="post__meta">
    <span class="post__time">2014-09-10</span>

  </div>
</header>

 <div class="post-content"><pre data-lang="mm" style="background-color:#212121;color:#eeffff;" class="language-mm "><code class="language-mm" data-lang="mm"><span style="font-style:italic;color:#4a4a4a;">//TheSingleton.h
</span><span style="font-style:italic;color:#89ddff;">@</span><span style="font-style:italic;color:#c792ea;">interface </span><span>TheSingleton </span><span style="color:#89ddff;">: </span><span style="color:#c3e88d;">NSObject
</span><span>
</span><span>+</span><span style="color:#89ddff;">(</span><span>instancetype</span><span style="color:#89ddff;">) </span><span style="color:#82aaff;">sharedInstance</span><span style="color:#89ddff;">;
</span><span>
</span><span>+</span><span style="color:#89ddff;">(</span><span>instancetype</span><span style="color:#89ddff;">) </span><span style="color:#82aaff;">alloc</span><span> __attribute__</span><span style="color:#89ddff;">((</span><span style="color:#82aaff;">unavailable</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">alloc not available, call sharedInstance instead</span><span style="color:#89ddff;">&quot;))</span><span style="background-color:#ff5370;color:#ffffff;">)</span><span style="color:#89ddff;">;
</span><span style="color:#89ddff;">-(</span><span>instancetype</span><span style="color:#89ddff;">)</span><span> init </span><span style="color:#c792ea;">__attribute__</span><span style="color:#89ddff;">((</span><span>unavailable</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">init not available, call sharedInstance instead</span><span style="color:#89ddff;">&quot;)));
</span><span style="color:#89ddff;">+(</span><span>instancetype</span><span style="color:#89ddff;">) </span><span style="font-style:italic;color:#c792ea;">new </span><span style="color:#c792ea;">__attribute__</span><span style="color:#89ddff;">((</span><span>unavailable</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">new not available, call sharedInstance instead</span><span style="color:#89ddff;">&quot;)));
</span><span style="color:#89ddff;">-(</span><span>instancetype</span><span style="color:#89ddff;">)</span><span> copy </span><span style="color:#c792ea;">__attribute__</span><span style="color:#89ddff;">((</span><span>unavailable</span><span style="color:#89ddff;">(&quot;</span><span style="color:#c3e88d;">copy not available, call sharedInstance instead</span><span style="color:#89ddff;">&quot;)));
</span><span>
</span><span>@end
</span></code></pre>
<span id="continue-reading"></span><pre data-lang="mm" style="background-color:#212121;color:#eeffff;" class="language-mm "><code class="language-mm" data-lang="mm"><span style="font-style:italic;color:#4a4a4a;">//TheSingleton.m
</span><span style="font-style:italic;color:#89ddff;">@</span><span style="font-style:italic;color:#c792ea;">implementation </span><span>TheSingleton
</span><span>
</span><span>+</span><span style="color:#89ddff;">(</span><span>instancetype</span><span style="color:#89ddff;">) </span><span style="color:#82aaff;">sharedInstance </span><span style="color:#89ddff;">{
</span><span>  </span><span style="color:#c792ea;">static</span><span> dispatch_once_t pred</span><span style="color:#89ddff;">;
</span><span>  </span><span style="color:#c792ea;">static </span><span style="font-style:italic;color:#c792ea;">id </span><span>shared </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">nil</span><span style="color:#89ddff;">;
</span><span>  </span><span style="color:#82aaff;">dispatch_once</span><span style="color:#89ddff;">(&amp;</span><span style="color:#82aaff;">pred</span><span style="color:#89ddff;">, ^{
</span><span style="color:#82aaff;">    shared </span><span style="color:#89ddff;">= [[</span><span style="font-style:italic;color:#ff5370;">super </span><span style="color:#82aaff;">alloc</span><span style="color:#89ddff;">]</span><span style="color:#82aaff;"> initUniqueInstance</span><span style="color:#89ddff;">];
</span><span style="color:#82aaff;">  </span><span style="color:#89ddff;">});
</span><span>  </span><span style="font-style:italic;color:#c792ea;">return</span><span> shared</span><span style="color:#89ddff;">;
</span><span style="color:#89ddff;">}
</span><span>
</span><span>-</span><span style="color:#89ddff;">(</span><span>instancetype</span><span style="color:#89ddff;">) </span><span style="color:#82aaff;">initUniqueInstance </span><span style="color:#89ddff;">{
</span><span>  </span><span style="font-style:italic;color:#c792ea;">id </span><span>me </span><span style="color:#89ddff;">= [</span><span style="font-style:italic;color:#ff5370;">super </span><span style="color:#82aaff;">init</span><span style="color:#89ddff;">];
</span><span>  </span><span style="font-style:italic;color:#4a4a4a;">// other initialize here.
</span><span>  </span><span style="font-style:italic;color:#c792ea;">return</span><span> me</span><span style="color:#89ddff;">;
</span><span style="color:#89ddff;">}
</span><span>
</span><span style="font-style:italic;color:#89ddff;">@</span><span style="font-style:italic;color:#c792ea;">end
</span></code></pre>
<p>
  ObjC版使用：</p>
<pre data-lang="mm" style="background-color:#212121;color:#eeffff;" class="language-mm "><code class="language-mm" data-lang="mm"><span>TheSingleton</span><span style="color:#89ddff;">*</span><span> instance </span><span style="color:#89ddff;">= [</span><span>TheSingleton </span><span style="color:#82aaff;">sharedInstance</span><span style="color:#89ddff;">];
</span></code></pre>
<p>
  swift 版：</p>
<pre data-lang="swift" style="background-color:#212121;color:#eeffff;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="font-style:italic;color:#c792ea;">class</span><span> TheSingleton {
</span><span>
</span><span>  </span><span style="font-style:italic;color:#c792ea;">class var</span><span> sharedInstance </span><span style="color:#89ddff;">:</span><span> TheSingleton {
</span><span>    </span><span style="font-style:italic;color:#c792ea;">struct</span><span> Static {
</span><span>      </span><span style="color:#c792ea;">static </span><span style="font-style:italic;color:#c792ea;">var</span><span> onceToken </span><span style="color:#89ddff;">:</span><span> dispatch_once_t </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">0
</span><span>      </span><span style="color:#c792ea;">static </span><span style="font-style:italic;color:#c792ea;">var</span><span> instance </span><span style="color:#89ddff;">:</span><span> TheSingleton? </span><span style="color:#89ddff;">= </span><span>nil
</span><span>    }
</span><span>    dispatch_once(</span><span style="color:#89ddff;">&amp;</span><span>Static</span><span style="color:#89ddff;">.</span><span>onceToken) {
</span><span>      Static</span><span style="color:#89ddff;">.</span><span>instance </span><span style="color:#89ddff;">=</span><span> TheSingleton()
</span><span>    }
</span><span>    </span><span style="font-style:italic;color:#c792ea;">return</span><span> Static</span><span style="color:#89ddff;">.</span><span>instance</span><span style="color:#89ddff;">!
</span><span>  }
</span><span>}
</span></code></pre>
<p>
  或者：</p>
<pre data-lang="swift" style="background-color:#212121;color:#eeffff;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="font-style:italic;color:#c792ea;">class</span><span> TheSingleton {
</span><span>
</span><span>  </span><span style="font-style:italic;color:#c792ea;">class var</span><span> sharedInstance </span><span style="color:#89ddff;">:</span><span> TheSingleton {
</span><span>    </span><span style="font-style:italic;color:#c792ea;">struct</span><span> Static {
</span><span>      </span><span style="color:#c792ea;">static </span><span style="font-style:italic;color:#c792ea;">let</span><span> instance </span><span style="color:#89ddff;">:</span><span> TheSingleton </span><span style="color:#89ddff;">=</span><span> TheSingleton()
</span><span>    }
</span><span>    </span><span style="font-style:italic;color:#c792ea;">return</span><span> Static</span><span style="color:#89ddff;">.</span><span>instance
</span><span>  }
</span><span>
</span><span>}
</span></code></pre>
<p>
  swift版使用：</p>
<pre data-lang="swift" style="background-color:#212121;color:#eeffff;" class="language-swift "><code class="language-swift" data-lang="swift"><span style="font-style:italic;color:#c792ea;">let</span><span> instance </span><span style="color:#89ddff;">=</span><span> TheSingleton</span><span style="color:#89ddff;">.</span><span>sharedInstance
</span></code></pre>
<p>
  &nbsp;</p>
<p>
  C++1x Singleton，下面的方法已经过时了，其实C++11有更简单的实现方式：</p>
<pre data-lang="cpp" style="background-color:#212121;color:#eeffff;" class="language-cpp "><code class="language-cpp" data-lang="cpp"><span style="font-style:italic;color:#c792ea;">#ifndef</span><span> SINGLETON_H
</span><span style="font-style:italic;color:#c792ea;">#define </span><span>SINGLETON_H
</span><span>
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">mutex</span><span style="color:#89ddff;">&gt;
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">functional</span><span style="color:#89ddff;">&gt;
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">memory</span><span style="color:#89ddff;">&gt;
</span><span style="font-style:italic;color:#c792ea;">#include </span><span style="color:#89ddff;">&lt;</span><span style="color:#c3e88d;">utility</span><span style="color:#89ddff;">&gt;
</span><span>
</span><span style="font-style:italic;color:#c792ea;">template</span><span style="color:#89ddff;">&lt;</span><span style="font-style:italic;color:#c792ea;">class</span><span> SingleClass</span><span style="color:#89ddff;">&gt;
</span><span style="font-style:italic;color:#c792ea;">class </span><span style="color:#ffcb6b;">Singleton
</span><span style="color:#89ddff;">{
</span><span style="color:#c792ea;">public</span><span style="color:#89ddff;">:
</span><span>  </span><span style="color:#82aaff;">Singleton</span><span style="color:#89ddff;">() = </span><span style="color:#c792ea;">default</span><span style="color:#89ddff;">;
</span><span>  </span><span style="color:#c792ea;">virtual </span><span style="color:#82aaff;">~Singleton</span><span style="color:#89ddff;">() = </span><span style="color:#c792ea;">default</span><span style="color:#89ddff;">;
</span><span>
</span><span>  </span><span style="color:#82aaff;">Singleton</span><span style="color:#89ddff;">(</span><span style="color:#c792ea;">const</span><span> Singleton</span><span style="color:#89ddff;">&amp;) = </span><span style="color:#c792ea;">delete</span><span style="color:#89ddff;">;
</span><span>  Singleton</span><span style="color:#89ddff;">&amp; </span><span style="color:#82aaff;">operator=</span><span style="color:#89ddff;">(</span><span style="color:#c792ea;">const</span><span> Singleton</span><span style="color:#89ddff;">&amp;) = </span><span style="color:#c792ea;">delete</span><span style="color:#89ddff;">;
</span><span>
</span><span>  </span><span style="font-style:italic;color:#c792ea;">template</span><span style="color:#89ddff;">&lt;</span><span style="font-style:italic;color:#c792ea;">typename</span><span> IMPL </span><span style="color:#89ddff;">=</span><span> SingleClass</span><span style="color:#89ddff;">, </span><span style="font-style:italic;color:#c792ea;">typename</span><span style="color:#89ddff;">...</span><span> Args</span><span style="color:#89ddff;">&gt;
</span><span>  </span><span style="color:#c792ea;">static</span><span> SingleClass</span><span style="color:#89ddff;">&amp; </span><span style="color:#82aaff;">instance</span><span style="color:#89ddff;">(</span><span>Args</span><span style="color:#89ddff;">&amp;&amp;... </span><span style="color:#f78c6c;">args</span><span style="color:#89ddff;">)
</span><span>  </span><span style="color:#89ddff;">{
</span><span>  </span><span style="color:#82aaff;">std</span><span style="color:#89ddff;">::</span><span style="color:#82aaff;">call_once</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">get_once_flag</span><span style="color:#89ddff;">(), [](</span><span style="color:#82aaff;">Args </span><span style="color:#89ddff;">&amp;&amp; ...</span><span style="color:#82aaff;"> arg</span><span style="color:#89ddff;">) {
</span><span style="color:#82aaff;">    _instance</span><span style="color:#89ddff;">.</span><span style="color:#82aaff;">reset</span><span style="color:#89ddff;">(</span><span style="font-style:italic;color:#c792ea;">new </span><span style="color:#82aaff;">IMPL</span><span style="color:#89ddff;">(</span><span style="color:#82aaff;">std</span><span style="color:#89ddff;">::</span><span style="color:#82aaff;">forward</span><span style="color:#89ddff;">&lt;</span><span style="color:#82aaff;">Args</span><span style="color:#89ddff;">&gt;(</span><span style="color:#82aaff;">arg</span><span style="color:#89ddff;">)...));
</span><span style="color:#82aaff;">  </span><span style="color:#89ddff;">}, </span><span style="color:#82aaff;">std</span><span style="color:#89ddff;">::</span><span style="color:#82aaff;">forward</span><span style="color:#89ddff;">&lt;</span><span style="color:#82aaff;">Args</span><span style="color:#89ddff;">&gt;(</span><span style="color:#82aaff;">args</span><span style="color:#89ddff;">)...);
</span><span>  </span><span style="font-style:italic;color:#c792ea;">return </span><span style="color:#89ddff;">*(</span><span>_instance</span><span style="color:#89ddff;">.</span><span style="color:#82aaff;">get</span><span style="color:#89ddff;">());
</span><span>  </span><span style="color:#89ddff;">};
</span><span>
</span><span style="color:#c792ea;">private</span><span style="color:#89ddff;">:
</span><span>  </span><span style="color:#c792ea;">static</span><span> std</span><span style="color:#89ddff;">::</span><span>unique_ptr</span><span style="color:#89ddff;">&lt;</span><span>SingleClass</span><span style="color:#89ddff;">&gt;</span><span> _instance</span><span style="color:#89ddff;">;
</span><span>  </span><span style="color:#c792ea;">static</span><span> std</span><span style="color:#89ddff;">::</span><span>once_flag</span><span style="color:#89ddff;">&amp; </span><span style="color:#82aaff;">get_once_flag</span><span style="color:#89ddff;">() {
</span><span>  </span><span style="color:#c792ea;">static</span><span> std</span><span style="color:#89ddff;">::</span><span>once_flag once</span><span style="color:#89ddff;">;
</span><span>  </span><span style="font-style:italic;color:#c792ea;">return</span><span> once</span><span style="color:#89ddff;">;
</span><span>  </span><span style="color:#89ddff;">};
</span><span style="color:#89ddff;">};
</span><span>
</span><span style="font-style:italic;color:#c792ea;">template</span><span style="color:#89ddff;">&lt;</span><span style="font-style:italic;color:#c792ea;">class</span><span> T</span><span style="color:#89ddff;">&gt;</span><span> std</span><span style="color:#89ddff;">::</span><span>unique_ptr</span><span style="color:#89ddff;">&lt;</span><span>T</span><span style="color:#89ddff;">&gt;</span><span> Singleton</span><span style="color:#89ddff;">&lt;</span><span>T</span><span style="color:#89ddff;">&gt;::</span><span>_instance </span><span style="color:#89ddff;">= </span><span style="color:#f78c6c;">nullptr</span><span style="color:#89ddff;">;
</span><span>
</span><span style="font-style:italic;color:#c792ea;">#endif
</span></code></pre>
</div>


  <div class="post-footer">

  
    <div class="post-tags">
    
      <!-- <a href="https://xjump.me/tags/all/">#all</a> -->
    
    </div>
  
  
    <div class="post-nav">
    
      <a class="previous" href="https:&#x2F;&#x2F;xjump.me&#x2F;20140630-cve-2014-0038&#x2F;">‹ CVE-2014-0038</a>
    
    
      <a class="next" href="https:&#x2F;&#x2F;xjump.me&#x2F;20140910-ddj&#x2F;">道德经 ›</a>
    
    
    
    </div>
  

  </div>


</article>

      </div>
    </main>



  </div>


<script type="text/javascript" src="/even.js"></script>

</body></html>
